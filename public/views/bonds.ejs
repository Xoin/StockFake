<%- include('partials/header', { 
    title: 'Bonds',
    pageTitle: 'üí∞ BOND MARKET',
    pageStyles: `
        .content-wrapper {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        #filterSidebar {
            flex: 0 0 250px;
        }
        .bonds-container {
            flex: 1;
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 15px;
        }
        .bonds-container table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .bonds-container th {
            background-color: #001100;
            color: #00ff00;
            padding: 10px;
            text-align: left;
            border: 1px solid #003300;
        }
        .bonds-container td {
            padding: 8px 10px;
            border: 1px solid #003300;
        }
        .bonds-container tr:hover {
            background-color: #002200;
        }
        .rating-AAA, .rating-AA { color: #00ff00; }
        .rating-A, .rating-BBB { color: #ffff00; }
        .rating-BB, .rating-B { color: #ff8800; }
        .rating-CCC, .rating-CC, .rating-C, .rating-D { color: #ff0000; }
        .trade-form {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-top: 20px;
        }
        .trade-form select, .trade-form input {
            background-color: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 8px;
            margin: 5px 0;
            width: 100%;
            font-family: 'Courier New', monospace;
        }
        .trade-form button {
            background-color: #000;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px 5px 0 0;
            font-family: 'Courier New', monospace;
        }
        .trade-form button:hover {
            background-color: #002200;
        }
        .holdings-section {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 15px;
            margin-top: 20px;
        }
        .bond-type-treasury { color: #00ccff; }
        .bond-type-corporate { color: #ffaa00; }
        .bond-type-municipal { color: #ff00ff; }
        .positive { color: #00ff00; }
        .negative { color: #ff0000; }
        #filterSidebar select {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            background-color: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            font-family: 'Courier New', monospace;
        }
        .stats-box {
            background-color: #001100;
            border: 1px solid #003300;
            padding: 10px;
            margin: 10px 0;
        }
    `
}) %>

<div class="container">
    <div class="content-wrapper">
        <div id="filterSidebar">
            <h2>üîç FILTERS</h2>
            <select id="bondTypeFilter" onchange="filterBonds()">
                <option value="all">All Bond Types</option>
                <option value="treasury">Treasury Securities</option>
                <option value="corporate">Corporate Bonds</option>
                <option value="municipal">Municipal Bonds</option>
            </select>
            
            <select id="ratingFilter" onchange="filterBonds()">
                <option value="all">All Ratings</option>
                <option value="AAA">AAA - Highest</option>
                <option value="AA">AA - High</option>
                <option value="A">A - Good</option>
                <option value="BBB">BBB - Medium</option>
                <option value="BB">BB - Speculative</option>
                <option value="B">B - High Risk</option>
            </select>
            
            <div class="stats-box">
                <h3>üìä YIELD CURVE</h3>
                <div id="yieldCurve">Loading...</div>
            </div>
            
            <div class="stats-box">
                <h3>üíº PORTFOLIO</h3>
                <div id="portfolioStats">Loading...</div>
            </div>
        </div>

        <div class="bonds-container">
            <h2>üìã AVAILABLE BONDS</h2>
            <p>Trade US Treasury securities, corporate bonds, and municipal bonds.</p>
            
            <div id="bondsTable">
                <p>Loading bonds...</p>
            </div>

            <div class="trade-form">
                <h3>üîÑ TRADE BONDS</h3>
                <div id="tradeFormContent">
                    <label>Bond Symbol:</label>
                    <input type="text" id="bondSymbol" placeholder="e.g., T-NOTE-10Y" />
                    
                    <label>Quantity:</label>
                    <input type="number" id="quantity" min="1" value="1" />
                    
                    <div id="bondInfo" style="margin: 15px 0; padding: 10px; border: 1px solid #003300;"></div>
                    
                    <button onclick="buyBond()">üí∞ BUY BOND</button>
                </div>
            </div>
        </div>
    </div>

    <div class="holdings-section">
        <h2>üìö YOUR BOND HOLDINGS</h2>
        <div id="bondHoldings">
            <p>Loading holdings...</p>
        </div>
    </div>
</div>

<script>
let allBonds = [];
let bondHoldings = [];
let yieldCurve = {};

async function loadData() {
    try {
        // Load available bonds
        const bondsResponse = await fetch('/api/bonds');
        allBonds = await bondsResponse.json();
        
        // Load bond holdings
        const holdingsResponse = await fetch('/api/bonds/holdings/all');
        bondHoldings = await holdingsResponse.json();
        
        // Load yield curve
        const yieldResponse = await fetch('/api/bonds/yields/curve');
        yieldCurve = await yieldResponse.json();
        
        // Load portfolio stats
        const statsResponse = await fetch('/api/bonds/portfolio/stats');
        const stats = await statsResponse.json();
        
        displayBonds();
        displayHoldings();
        displayYieldCurve();
        displayPortfolioStats(stats);
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

function displayBonds() {
    const table = `
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Maturity</th>
                    <th>Coupon</th>
                    <th>Price</th>
                    <th>Yield</th>
                    <th>Rating</th>
                    <th>Min Buy</th>
                </tr>
            </thead>
            <tbody id="bondsTableBody">
            </tbody>
        </table>
    `;
    
    document.getElementById('bondsTable').innerHTML = table;
    filterBonds();
}

function filterBonds() {
    const typeFilter = document.getElementById('bondTypeFilter').value;
    const ratingFilter = document.getElementById('ratingFilter').value;
    
    let filtered = allBonds.filter(bond => {
        if (typeFilter !== 'all' && bond.type !== typeFilter) return false;
        if (ratingFilter !== 'all' && bond.creditRating !== ratingFilter) return false;
        return true;
    });
    
    const tbody = document.getElementById('bondsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = filtered.map(bond => {
        const maturity = bond.maturityWeeks 
            ? `${bond.maturityWeeks} weeks`
            : `${bond.maturityYears} years`;
        const coupon = (bond.couponRate * 100).toFixed(2) + '%';
        const price = '$' + bond.marketPrice.toFixed(2);
        const yieldPct = bond.currentYield.toFixed(2) + '%';
        
        return `
            <tr onclick="selectBond('${bond.symbol}')" style="cursor: pointer;">
                <td><span class="bond-type-${bond.type}">${bond.symbol}</span></td>
                <td>${bond.name}</td>
                <td>${bond.type}</td>
                <td>${maturity}</td>
                <td>${coupon}</td>
                <td>${price}</td>
                <td>${yieldPct}</td>
                <td><span class="rating-${bond.creditRating}">${bond.creditRating}</span></td>
                <td>$${bond.minPurchase}</td>
            </tr>
        `;
    }).join('');
}

function selectBond(symbol) {
    document.getElementById('bondSymbol').value = symbol;
    updateBondInfo();
}

async function updateBondInfo() {
    const symbol = document.getElementById('bondSymbol').value;
    const quantity = parseInt(document.getElementById('quantity').value) || 1;
    
    if (!symbol) {
        document.getElementById('bondInfo').innerHTML = '';
        return;
    }
    
    const bond = allBonds.find(b => b.symbol === symbol);
    if (!bond) {
        document.getElementById('bondInfo').innerHTML = '<span class="negative">Bond not found</span>';
        return;
    }
    
    const totalCost = bond.marketPrice * quantity;
    const tradingFee = totalCost * 0.001;
    const total = totalCost + tradingFee;
    
    document.getElementById('bondInfo').innerHTML = `
        <strong>${bond.name}</strong><br/>
        Price per bond: $${bond.marketPrice.toFixed(2)}<br/>
        Quantity: ${quantity}<br/>
        Subtotal: $${totalCost.toFixed(2)}<br/>
        Trading Fee: $${tradingFee.toFixed(2)}<br/>
        <strong>Total Cost: $${total.toFixed(2)}</strong>
    `;
}

async function buyBond() {
    const symbol = document.getElementById('bondSymbol').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    
    if (!symbol || !quantity) {
        alert('Please enter bond symbol and quantity');
        return;
    }
    
    try {
        const response = await fetch('/api/bonds/buy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol, quantity })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(`Successfully purchased ${quantity} ${symbol} bond(s)\nTotal: $${result.totalAmount.toFixed(2)}\nRemaining Cash: $${result.remainingCash.toFixed(2)}`);
            loadData(); // Reload data
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error buying bond: ' + error.message);
    }
}

async function sellBond(bondId, availableQuantity) {
    const quantity = prompt(`How many bonds to sell? (Available: ${availableQuantity})`, '1');
    if (!quantity || parseInt(quantity) <= 0) return;
    
    try {
        const response = await fetch('/api/bonds/sell', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bondId, quantity: parseInt(quantity) })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(`Successfully sold ${quantity} bond(s)\nProceeds: $${result.finalProceeds.toFixed(2)}\nGain/Loss: $${result.gainLoss.toFixed(2)}`);
            loadData(); // Reload data
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error selling bond: ' + error.message);
    }
}

function displayHoldings() {
    if (bondHoldings.length === 0) {
        document.getElementById('bondHoldings').innerHTML = '<p>No bond holdings</p>';
        return;
    }
    
    const totalValue = bondHoldings.reduce((sum, h) => sum + h.currentValue, 0);
    const totalCost = bondHoldings.reduce((sum, h) => sum + h.totalCost, 0);
    const totalGainLoss = totalValue - totalCost;
    
    const table = `
        <p>Total Holdings Value: $${totalValue.toFixed(2)} | 
        Total Cost: $${totalCost.toFixed(2)} | 
        Gain/Loss: <span class="${totalGainLoss >= 0 ? 'positive' : 'negative'}">$${totalGainLoss.toFixed(2)}</span></p>
        
        <table>
            <thead>
                <tr>
                    <th>Issuer</th>
                    <th>Type</th>
                    <th>Face Value</th>
                    <th>Coupon</th>
                    <th>Quantity</th>
                    <th>Purchase Price</th>
                    <th>Current Price</th>
                    <th>Current Value</th>
                    <th>Gain/Loss</th>
                    <th>Maturity</th>
                    <th>Rating</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                ${bondHoldings.map(holding => {
                    const gainLoss = holding.gainLoss;
                    const gainLossClass = gainLoss >= 0 ? 'positive' : 'negative';
                    const maturityDate = new Date(holding.maturityDate).toLocaleDateString();
                    
                    return `
                        <tr>
                            <td><span class="bond-type-${holding.bondType}">${holding.issuer}</span></td>
                            <td>${holding.bondType}</td>
                            <td>$${holding.faceValue}</td>
                            <td>${(holding.couponRate * 100).toFixed(2)}%</td>
                            <td>${holding.quantity}</td>
                            <td>$${holding.purchasePrice.toFixed(2)}</td>
                            <td>$${holding.currentPrice.toFixed(2)}</td>
                            <td>$${holding.currentValue.toFixed(2)}</td>
                            <td><span class="${gainLossClass}">$${gainLoss.toFixed(2)}</span></td>
                            <td>${maturityDate}</td>
                            <td><span class="rating-${holding.creditRating}">${holding.creditRating}</span></td>
                            <td><button onclick="sellBond(${holding.id}, ${holding.quantity})">Sell</button></td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;
    
    document.getElementById('bondHoldings').innerHTML = table;
}

function displayYieldCurve() {
    const curveHTML = Object.keys(yieldCurve)
        .map(maturity => `${maturity}: ${(yieldCurve[maturity] * 100).toFixed(2)}%`)
        .join('<br/>');
    document.getElementById('yieldCurve').innerHTML = curveHTML;
}

function displayPortfolioStats(stats) {
    const statsHTML = `
        Holdings: ${stats.totalHoldings}<br/>
        Value: $${stats.totalValue.toFixed(2)}<br/>
        Duration: ${stats.duration.toFixed(2)} years
    `;
    document.getElementById('portfolioStats').innerHTML = statsHTML;
}

// Event listeners
document.getElementById('bondSymbol').addEventListener('input', updateBondInfo);
document.getElementById('quantity').addEventListener('input', updateBondInfo);

// Load data on page load
loadData();

// Refresh data periodically
setInterval(loadData, 10000);
</script>

<%- include('partials/footer') %>
