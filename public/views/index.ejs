<%- include('partials/header', { 
    title: 'Portal',
    pageTitle: 'âš¡ STOCKFAKE TERMINAL âš¡',
    pageStyles: `
        .hero-section {
            background: linear-gradient(180deg, #001100 0%, #000000 100%);
            border: 2px solid #00ff00;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        .hero-section h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        .hero-section .tagline {
            font-size: 1.2em;
            color: #00aa00;
            margin-bottom: 20px;
        }
        .account-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #000;
            border: 1px solid #00ff00;
            padding: 15px;
            text-align: center;
        }
        .stat-card .label {
            color: #00aa00;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .stat-card .value {
            color: #00ff00;
            font-size: 1.5em;
            font-weight: bold;
        }
        .controls {
            background: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 30px;
        }
        .controls h3 {
            margin: 0 0 15px 0;
            color: #00ff00;
            border-bottom: 1px solid #003300;
            padding-bottom: 10px;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            align-items: start;
        }
        .controls-status {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .status-indicator {
            padding: 10px;
            border: 1px solid #00ff00;
            background: #001100;
            font-weight: bold;
        }
        .paused-indicator { color: #ff8800; border-color: #ff8800; }
        .running-indicator { color: #00ff00; border-color: #00ff00; }
        .speed-indicator { color: #00aaff; border-color: #00aaff; }
        .controls-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .controls button {
            padding: 12px;
            font-size: 0.95em;
        }
        .section-header {
            color: #00ff00;
            font-size: 1.8em;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #00ff00;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
        }
        .portal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .portal-link {
            background: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            text-decoration: none;
            color: #00ff00;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: relative;
        }
        .portal-link:hover {
            background: #001100;
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
            transform: translateY(-2px);
        }
        .portal-link h2 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
        }
        .portal-link p {
            margin: 0;
            color: #00aa00;
            font-size: 0.9em;
        }
        .portal-link.featured {
            border-color: #00ffff;
            background: #000033;
        }
        .portal-link.featured:hover {
            background: #001144;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }
        .portal-link.featured h2 {
            color: #00ffff;
        }
        .portal-link.debug {
            border-color: #ff00ff;
            background: #110011;
        }
        .portal-link.debug:hover {
            background: #220022;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.4);
        }
        .notification-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff0000;
            color: #fff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .category-section {
            margin-bottom: 40px;
        }
    `
}) %>

<div class="hero-section">
    <h1>âš¡ STOCKFAKE TERMINAL âš¡</h1>
    <p class="tagline">Historical Stock Market Simulation â€¢ 1970 - Present</p>
    <div class="account-overview" id="accountOverview">
        <div class="stat-card">
            <div class="label">CASH BALANCE</div>
            <div class="value" id="cashBalance">Loading...</div>
        </div>
        <div class="stat-card">
            <div class="label">PORTFOLIO VALUE</div>
            <div class="value" id="portfolioValue">Loading...</div>
        </div>
        <div class="stat-card">
            <div class="label">TOTAL NET WORTH</div>
            <div class="value" id="netWorth">Loading...</div>
        </div>
        <div class="stat-card">
            <div class="label">CREDIT SCORE</div>
            <div class="value" id="creditScore">Loading...</div>
        </div>
    </div>
</div>

<div class="controls">
    <h3>â± TIME CONTROL SYSTEM</h3>
    <div class="controls-grid">
        <div class="controls-status">
            <span id="pauseStatus" class="status-indicator">...</span>
            <span id="speedStatus" class="status-indicator speed-indicator">...</span>
        </div>
        <div class="controls-buttons">
            <button onclick="togglePause()">â¯ Pause/Resume</button>
            <button onclick="setSpeed(1)">ğŸ• Realtime</button>
            <button onclick="setSpeed(60)">ğŸŒ Slow</button>
            <button onclick="setSpeed(3600)">âš¡ Normal</button>
            <button onclick="setSpeed(86400)">ğŸš€ Fast</button>
            <button onclick="setSpeed(2592000)">ğŸ“… Monthly</button>
        </div>
    </div>
</div>

<div class="category-section">
    <div class="section-header">ğŸ“Š TRADING & INVESTMENTS</div>
    <div class="portal-grid">
            <a href="/trading" class="portal-link">
                <h2>ğŸ“ˆ Stocks</h2>
                <p>Trade individual stocks â€¢ NYSE hours</p>
            </a>
            <a href="/indexfunds" class="portal-link">
                <h2>ğŸ“Š Index Funds</h2>
                <p>Diversified portfolios â€¢ S&P 500, NASDAQ</p>
            </a>
            <a href="/crypto" class="portal-link featured">
                <h2>â‚¿ Cryptocurrency</h2>
                <p>Digital assets â€¢ 24/7 trading â€¢ High volatility</p>
            </a>
            <a href="/bonds" class="portal-link">
                <h2>ğŸ’° Bonds</h2>
                <p>Fixed income â€¢ Treasuries & corporate bonds</p>
            </a>
        </div>
    </div>

    <div class="category-section">
        <div class="section-header">ğŸ¦ ACCOUNT & FINANCES</div>
        <div class="portal-grid">
            <a href="/bank" class="portal-link">
                <h2>ğŸ¦ Bank Account</h2>
                <p>View balance, portfolio & transaction history</p>
            </a>
            <a href="/loans" class="portal-link">
                <h2>ğŸ’³ Loans</h2>
                <p>Borrow money â€¢ Manage credit & debt</p>
            </a>
            <a href="/taxes" class="portal-link">
                <h2>ğŸ“‘ Tax Center</h2>
                <p>Capital gains â€¢ Tax obligations & history</p>
            </a>
            <a href="/pendingorders" class="portal-link">
                <h2>ğŸ“‹ Pending Orders</h2>
                <p>Queued trades â€¢ After-hours orders</p>
            </a>
        </div>
    </div>

    <div class="category-section">
        <div class="section-header">ğŸ“° INFORMATION & MONITORING</div>
        <div class="portal-grid">
            <a href="/graphs" class="portal-link">
                <h2>ğŸ“‰ Market Charts</h2>
                <p>Price trends â€¢ Technical analysis</p>
            </a>
            <a href="/events" class="portal-link">
                <h2>âš¡ Market Events</h2>
                <p>Crashes â€¢ Corporate actions â€¢ Economic data</p>
            </a>
            <a href="/news" class="portal-link" id="newsLink">
                <h2>ğŸ“° News</h2>
                <p>Historical events â€¢ Breaking market news</p>
                <span id="newsBadge" class="notification-badge" style="display: none;">0</span>
            </a>
            <a href="/email" class="portal-link" id="emailLink">
                <h2>ğŸ“§ Email</h2>
                <p>System messages â€¢ Trade confirmations</p>
                <span id="emailBadge" class="notification-badge" style="display: none;">0</span>
            </a>
        </div>
    </div>

    <div class="category-section">
        <div class="section-header">ğŸ”§ SYSTEM & UTILITIES</div>
        <div class="portal-grid">
            <a href="/status" class="portal-link">
                <h2>ğŸ–¥ï¸ Server Status</h2>
                <p>Performance metrics â€¢ System monitoring</p>
            </a>
            <a href="/cheat" class="portal-link debug">
                <h2>ğŸ”§ Debug Console</h2>
                <p style="color: #ff00ff;">Developer tools â€¢ Testing utilities</p>
            </a>
        </div>
    </div>

<%- include('partials/footer', {
    pageScripts: `
    <script>
    async function loadAccountOverview() {
        try {
            const response = await fetch('/api/account');
            const data = await response.json();
            
            document.getElementById('cashBalance').textContent = '$' + data.cash.toFixed(2);
            document.getElementById('portfolioValue').textContent = '$' + data.portfolioValue.toFixed(2);
            document.getElementById('netWorth').textContent = '$' + (data.cash + data.portfolioValue).toFixed(2);
            document.getElementById('creditScore').textContent = data.creditScore;
        } catch (error) {
            console.error('Error loading account overview:', error);
        }
    }
    
    async function updateTime() {
            const response = await fetch('/api/time');
            const data = await response.json();
            const date = new Date(data.currentTime);
            document.getElementById('gameTime').textContent = date.toLocaleString();
            
            const statusEl = document.getElementById('marketStatus');
            if (data.isMarketOpen) {
                statusEl.textContent = 'ğŸŸ¢ MARKET OPEN';
                statusEl.className = 'market-status market-open';
            } else {
                statusEl.textContent = 'ğŸ”´ MARKET CLOSED';
                statusEl.className = 'market-status market-closed';
            }
            
            // Update pause status
            const pauseStatusEl = document.getElementById('pauseStatus');
            if (data.isPaused) {
                pauseStatusEl.textContent = 'â¸ PAUSED';
                pauseStatusEl.className = 'status-indicator paused-indicator';
            } else {
                pauseStatusEl.textContent = 'â–¶ RUNNING';
                pauseStatusEl.className = 'status-indicator running-indicator';
            }
            
            // Update speed status
            const speedStatusEl = document.getElementById('speedStatus');
            let speedText = '';
            if (data.timeMultiplier === 1) {
                speedText = 'ğŸ• REALTIME (1s = 1s)';
            } else if (data.timeMultiplier === 60) {
                speedText = 'ğŸŒ SLOW (1s = 1min)';
            } else if (data.timeMultiplier === 3600) {
                speedText = 'âš¡ NORMAL (1s = 1hr)';
            } else if (data.timeMultiplier === 86400) {
                speedText = 'ğŸš€ FAST (1s = 1day)';
            } else if (data.timeMultiplier === 2592000) {
                speedText = 'ğŸ“… MONTHLY (1s = 1month)';
            } else {
                speedText = \`â± CUSTOM (1s = \${data.timeMultiplier}s)\`;
            }
            speedStatusEl.textContent = speedText;
        }
        
        async function togglePause() {
            await fetch('/api/time/pause', { method: 'POST' });
            updateTime();
        }
        
        async function setSpeed(multiplier) {
            await fetch('/api/time/speed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ multiplier })
            });
            updateTime();
        }
        
        // Update notification badges
        async function updateNotifications() {
            try {
                // Get current counts
                const newsResponse = await fetch('/api/news');
                const newsData = await newsResponse.json();
                
                const emailResponse = await fetch('/api/emails');
                const emailData = await emailResponse.json();
                
                // Get read tracking from localStorage (same keys as news.ejs and email.ejs)
                const readNewsTimestamps = JSON.parse(localStorage.getItem('readNewsTimestamps') || '{}');
                const readEmailTimestamps = JSON.parse(localStorage.getItem('readEmailTimestamps') || '{}');
                
                // Clean up old read items (older than 15 minutes)
                const AUTO_DISCARD_TIME = 15 * 60 * 1000;
                const now = Date.now();
                
                // Clean news timestamps
                for (const [newsId, timestamp] of Object.entries(readNewsTimestamps)) {
                    if (now - timestamp > AUTO_DISCARD_TIME) {
                        delete readNewsTimestamps[newsId];
                    }
                }
                localStorage.setItem('readNewsTimestamps', JSON.stringify(readNewsTimestamps));
                
                // Clean email timestamps
                for (const [emailId, timestamp] of Object.entries(readEmailTimestamps)) {
                    if (now - timestamp > AUTO_DISCARD_TIME) {
                        delete readEmailTimestamps[emailId];
                    }
                }
                localStorage.setItem('readEmailTimestamps', JSON.stringify(readEmailTimestamps));
                
                // Count unread items
                const readNewsIds = new Set(Object.keys(readNewsTimestamps).map(id => parseInt(id)));
                const unreadNewsCount = newsData.filter(item => !readNewsIds.has(item.id)).length;
                
                // Add IDs to emails if missing (same logic as email.ejs)
                emailData.forEach((email, idx) => {
                    if (!email.id) {
                        email.id = \`email-\${idx}-\${new Date(email.date).getTime()}\`;
                    }
                });
                const readEmailIds = new Set(Object.keys(readEmailTimestamps));
                const unreadEmailCount = emailData.filter(item => item.id && !readEmailIds.has(item.id)).length;
                
                // Update badges
                const newsBadge = document.getElementById('newsBadge');
                const emailBadge = document.getElementById('emailBadge');
                
                if (unreadNewsCount > 0) {
                    newsBadge.textContent = unreadNewsCount > 99 ? '99+' : unreadNewsCount;
                    newsBadge.style.display = 'flex';
                } else {
                    newsBadge.style.display = 'none';
                }
                
                if (unreadEmailCount > 0) {
                    emailBadge.textContent = unreadEmailCount > 99 ? '99+' : unreadEmailCount;
                    emailBadge.style.display = 'flex';
                } else {
                    emailBadge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error updating notifications:', error);
            }
        }
        
        updateTime();
        updateNotifications();
        loadAccountOverview();
        setInterval(updateTime, 1000);
        setInterval(updateNotifications, 3000); // Check every 3 seconds
        setInterval(loadAccountOverview, 5000); // Update account every 5 seconds
    </script>
    <script>
async function updateEraTheme() {
            const response = await fetch('/api/time');
            const data = await response.json();
            const gameDate = new Date(data.currentTime);
            const year = gameDate.getFullYear();
            applyEraTheme(year);
        }
        
        updateEraTheme();
        setInterval(updateEraTheme, 10000);
    </script>
    `
}) %>
