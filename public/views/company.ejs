<%- include('partials/header', { 
    title: 'Company Info',
    pageTitle: 'COMPANY INFORMATION',
    pageStyles: `
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
        }
        .error {
            background-color: #110000;
            border: 2px solid #ff0000;
            color: #ff0000;
            padding: 30px;
            text-align: center;
        }
        .company-header {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
        }
        .company-info {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stock-link {
            color: #00ff00;
            text-decoration: none;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            display: inline-block;
            margin-top: 20px;
        }
        .stock-link:hover {
            background-color: #003300;
        }
    `
}) %>

<div id="content">
            <div class="loading">Loading company information...</div>
        </div>

<%- include('partials/footer', {
    pageScripts: `
    <script>
// Get symbol from URL
        const urlPath = window.location.pathname;
        const symbol = urlPath.split('/company/')[1];
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function loadCompanyInfo() {
            try {
                const response = await fetch(\`/api/companies/\${encodeURIComponent(symbol)}\`);
                
                if (!response.ok) {
                    throw new Error('Company not found');
                }
                
                const company = await response.json();
                displayCompanyInfo(company);
            } catch (error) {
                document.getElementById('content').innerHTML = \`
                    <div class="error">
                        <h2>Error</h2>
                        <p>Company information not available: \${escapeHtml(error.message)}</p>
                        <a href="/trading" class="stock-link">‚Üê Back to Trading</a>
                    </div>
                \`;
            }
        }
        
        function formatCurrency(value) {
            if (value >= 1000) {
                return \`$\${(value / 1000).toFixed(2)}B\`;
            }
            return \`$\${value.toFixed(2)}M\`;
        }
        
        function formatNumber(value) {
            return value.toLocaleString();
        }
        
        function displayCompanyInfo(company) {
            const content = document.getElementById('content');
            
            const html = \`
                <div class="company-header">
                    <h2>\${escapeHtml(company.name)} (\${escapeHtml(symbol)})</h2>
                    <p>\${escapeHtml(company.description)}</p>
                    \${company.isDynamic ? '<p style="color: #00aa00; font-size: 0.9em; margin-top: 10px;">Note: Limited company information available. Data shown is estimated.</p>' : ''}
                    <div class="company-meta">
                        <div class="meta-item">
                            <div class="meta-label">Sector</div>
                            <div class="meta-value">\${escapeHtml(company.sector)}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Founded</div>
                            <div class="meta-value">\${escapeHtml(String(company.founded))}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Headquarters</div>
                            <div class="meta-value">\${escapeHtml(company.headquarters)}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Employees</div>
                            <div class="meta-value">\${formatNumber(company.employees)} <span style="font-size: 0.8em; color: #00aa00;">(\${escapeHtml(String(company.employeeYear))})</span></div>
                        </div>
                    </div>
                    <a href="/trading" class="stock-link">View Stock Price & Trade</a>
                </div>
                
                <div class="section">
                    <h3>üìà Stock Performance</h3>
                    <div id="stockMetrics" class="stock-metrics">
                        <div class="metric-card">
                            <div class="metric-label">Current Price</div>
                            <div class="metric-value" id="currentPrice">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Today's Change</div>
                            <div class="metric-value" id="priceChange">Loading...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Available Shares</div>
                            <div class="metric-value" id="availableShares">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="timeframe-buttons">
                        <button class="timeframe-btn active" onclick="loadStockHistory(7, this)">7 Days</button>
                        <button class="timeframe-btn" onclick="loadStockHistory(30, this)">30 Days</button>
                        <button class="timeframe-btn" onclick="loadStockHistory(90, this)">90 Days</button>
                        <button class="timeframe-btn" onclick="loadStockHistory(365, this)">1 Year</button>
                        <button class="timeframe-btn" onclick="loadStockHistory(1825, this)">5 Years</button>
                    </div>
                    
                    <div class="stock-chart-container">
                        <canvas id="stockChart" class="chart-canvas"></canvas>
                    </div>
                    
                    <div class="price-history-table">
                        <h4 style="margin-bottom: 10px;">Recent Price History</h4>
                        <table id="priceHistoryTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Price</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody id="priceHistoryBody">
                                <tr><td colspan="3" style="text-align: center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="section">
                    <h3>üíº Products & Services</h3>
                    <div class="products-grid">
                        \${company.products.map(product => \`
                            <div class="product-card">
                                <div class="product-name">\${escapeHtml(product.name)}</div>
                                <div class="product-category">\${escapeHtml(product.category)}</div>
                                <div class="product-year">Introduced: \${escapeHtml(String(product.yearIntroduced))}</div>
                            </div>
                        \`).join('')}
                    </div>
                    \${company.products.length === 0 ? '<p>No products available at this time.</p>' : ''}
                </div>
                
                <div class="section">
                    <h3>üß† Intellectual Property</h3>
                    <div class="ip-info">
                        <div class="ip-stat">
                            <div class="ip-label">Patents Held</div>
                            <div class="ip-value">\${formatNumber(company.intellectualProperty.patents)}</div>
                        </div>
                        <div class="ip-stat">
                            <div class="ip-label">Registered Trademarks</div>
                            <div class="trademarks">
                                \${company.intellectualProperty.trademarks.map(tm => \`
                                    <span class="trademark-badge">¬ÆÔ∏è \${escapeHtml(tm)}</span>
                                \`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>üí∞ Financial Information</h3>
                    <p style="color: #00aa00; margin-bottom: 10px;">Data as of year \${escapeHtml(String(company.financials.year))}</p>
                    <div class="financials-grid">
                        <div class="financial-card">
                            <div class="financial-label">Revenue</div>
                            <div class="financial-value">\${formatCurrency(company.financials.revenue)}</div>
                            <div class="financial-unit">Million USD</div>
                        </div>
                        <div class="financial-card">
                            <div class="financial-label">Net Income</div>
                            <div class="financial-value \${company.financials.netIncome >= 0 ? '' : 'negative'}">\${formatCurrency(company.financials.netIncome)}</div>
                            <div class="financial-unit">Million USD</div>
                        </div>
                        <div class="financial-card">
                            <div class="financial-label">Total Assets</div>
                            <div class="financial-value">\${formatCurrency(company.financials.assets)}</div>
                            <div class="financial-unit">Million USD</div>
                        </div>
                    </div>
                </div>
            \`;
            
            content.innerHTML = html;
        }
        
        // Load company info on page load
        loadCompanyInfo();
        
        // Stock chart and history functions
        let stockHistory = [];
        let currentTimeframe = 7;
        
        async function loadStockHistory(days, button) {
            currentTimeframe = days;
            
            // Update button states
            document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
            if (button) button.classList.add('active');
            
            try {
                const response = await fetch(\`/api/stocks/\${encodeURIComponent(symbol)}/history?days=\${days}\`);
                stockHistory = await response.json();
                
                drawStockChart();
                updatePriceHistory();
            } catch (error) {
                console.error('Error loading stock history:', error);
            }
        }
        
        async function loadStockInfo() {
            try {
                const response = await fetch(\`/api/stocks/\${encodeURIComponent(symbol)}\`);
                const stock = await response.json();
                
                document.getElementById('currentPrice').textContent = \`$\${stock.price.toFixed(2)}\`;
                
                const changeEl = document.getElementById('priceChange');
                const change = stock.change || 0;
                changeEl.textContent = \`\${change >= 0 ? '+' : ''}\${change.toFixed(2)}%\`;
                changeEl.style.color = change >= 0 ? '#00ff00' : '#ff0000';
                
                const sharesAvailable = stock.sharesAvailable || 0;
                const sharesDisplay = sharesAvailable > 1000000 
                    ? \`\${(sharesAvailable / 1000000).toFixed(1)}M\`
                    : sharesAvailable.toLocaleString();
                document.getElementById('availableShares').textContent = sharesDisplay;
            } catch (error) {
                console.error('Error loading stock info:', error);
            }
        }
        
        function drawStockChart() {
            const canvas = document.getElementById('stockChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size only if it changed
            const newWidth = canvas.offsetWidth;
            const newHeight = canvas.offsetHeight;
            if (canvas.width !== newWidth || canvas.height !== newHeight) {
                canvas.width = newWidth;
                canvas.height = newHeight;
            }
            
            if (stockHistory.length === 0) {
                ctx.fillStyle = '#00aa00';
                ctx.font = '16px Courier New';
                ctx.textAlign = 'center';
                ctx.fillText('No historical data available', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Calculate bounds
            const prices = stockHistory.map(d => d.price);
            const maxPrice = Math.max(...prices);
            const minPrice = Math.min(...prices);
            const priceRange = maxPrice - minPrice || 1;
            
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#003300';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                const price = maxPrice - (priceRange / 5) * i;
                ctx.fillStyle = '#00aa00';
                ctx.font = '12px Courier New';
                ctx.textAlign = 'right';
                ctx.fillText(\`$\${price.toFixed(2)}\`, padding - 5, y + 4);
            }
            
            // Draw price line
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            stockHistory.forEach((point, index) => {
                const x = padding + (chartWidth / (stockHistory.length - 1)) * index;
                const y = padding + chartHeight - ((point.price - minPrice) / priceRange) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw points
            stockHistory.forEach((point, index) => {
                const x = padding + (chartWidth / (stockHistory.length - 1)) * index;
                const y = padding + chartHeight - ((point.price - minPrice) / priceRange) * chartHeight;
                
                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw axes
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
        }
        
        function updatePriceHistory() {
            const tbody = document.getElementById('priceHistoryBody');
            
            if (stockHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No price history available</td></tr>';
                return;
            }
            
            // Show last 10 days
            const recentHistory = stockHistory.slice(-10).reverse();
            
            tbody.innerHTML = recentHistory.map((point, index) => {
                const date = new Date(point.date);
                const prevPoint = index < recentHistory.length - 1 ? recentHistory[index + 1] : point;
                const change = ((point.price - prevPoint.price) / prevPoint.price) * 100;
                const changeStr = index < recentHistory.length - 1 
                    ? \`\${change >= 0 ? '+' : ''}\${change.toFixed(2)}%\`
                    : '-';
                const changeClass = change >= 0 ? 'positive' : 'negative';
                
                return \`
                    <tr>
                        <td>\${date.toLocaleDateString()}</td>
                        <td>$\${point.price.toFixed(2)}</td>
                        <td class="\${changeClass}">\${changeStr}</td>
                    </tr>
                \`;
            }).join('');
        }
        
        // Initialize stock data
        loadStockInfo();
        loadStockHistory(7);
        setInterval(loadStockInfo, 5000);
    </script>
    <script>
async function updateEraTheme() {
            const response = await fetch('/api/time');
            const data = await response.json();
            const gameDate = new Date(data.currentTime);
            const year = gameDate.getFullYear();
            applyEraTheme(year);
        }
        
        updateEraTheme();
        setInterval(updateEraTheme, 10000);
    </script>
    `
}) %>
