<%- include('partials/header', { 
    title: 'Loans',
    pageTitle: 'ðŸ’° LOANS',
    pageStyles: `
        .credit-score {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .score-display {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }
        .score-excellent {
            color: #00ff00;
        }
        .score-good {
            color: #88ff00;
        }
        .score-fair {
            color: #ffff00;
        }
        .score-poor {
            color: #ff8800;
        }
        .score-bad {
            color: #ff0000;
        }
        .active-loans {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
        }
        .loan-item {
            background-color: #001100;
            border: 1px solid #003300;
            padding: 15px;
            margin-bottom: 15px;
        }
        .available-companies {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
        }
        .company-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .company-card {
            background-color: #001100;
            border: 2px solid #003300;
            padding: 20px;
            transition: all 0.3s;
        }
        .company-card:hover {
            background-color: #002200;
            border-color: #00ff00;
        }
        .trust-high {
            border-color: #00ff00;
        }
        .trust-medium {
            border-color: #ffff00;
        }
        .trust-low {
            border-color: #ff0000;
        }
        .company-card button {
            width: 100%;
            background-color: #003300;
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 10px;
            margin-top: 10px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }
        .company-card button:hover {
            background-color: #004400;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid;
        }
        .message.success {
            background-color: #001100;
            border-color: #00ff00;
            color: #00ff00;
        }
        .message.error {
            background-color: #110000;
            border-color: #ff0000;
            color: #ff0000;
        }
    `
}) %>

<div class="credit-score">
            <h2>Your Credit Score</h2>
            <div id="creditScore" class="score-display">---</div>
            <div id="creditRating">Loading...</div>
        </div>

        <div class="active-loans">
            <h2>Active Loans</h2>
            <div id="activeLoans">
                <p style="text-align: center; color: #00aa00;">No active loans</p>
            </div>
        </div>

        <div class="available-companies">
            <h2>Available Loan Companies</h2>
            <div id="message"></div>
            <div id="companies" class="company-grid">
                Loading...
            </div>
        </div>

<%- include('partials/footer', {
    pageScripts: `
    <script>
let accountData = null;

        function getCreditRating(score) {
            if (score >= 800) return { text: 'Excellent', class: 'score-excellent' };
            if (score >= 740) return { text: 'Very Good', class: 'score-good' };
            if (score >= 670) return { text: 'Good', class: 'score-good' };
            if (score >= 580) return { text: 'Fair', class: 'score-fair' };
            if (score >= 500) return { text: 'Poor', class: 'score-poor' };
            return { text: 'Very Poor', class: 'score-bad' };
        }

        function getTrustClass(level) {
            if (level >= 7) return 'trust-high';
            if (level >= 4) return 'trust-medium';
            return 'trust-low';
        }

        async function loadAccountData() {
            const response = await fetch('/api/account');
            accountData = await response.json();
            
            const score = accountData.creditScore;
            const rating = getCreditRating(score);
            
            document.getElementById('creditScore').textContent = score;
            document.getElementById('creditScore').className = \`score-display \${rating.class}\`;
            document.getElementById('creditRating').textContent = rating.text;
        }

        async function loadActiveLoans() {
            const response = await fetch('/api/loans/active');
            const loans = await response.json();
            
            // Get current game time to calculate days remaining correctly
            const timeResponse = await fetch('/api/time');
            const timeData = await timeResponse.json();
            const currentGameTime = new Date(timeData.currentTime);
            
            const container = document.getElementById('activeLoans');
            
            if (loans.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #00aa00;">No active loans</p>';
                return;
            }
            
            container.innerHTML = loans.map(loan => {
                const dueDate = new Date(loan.dueDate);
                const startDate = new Date(loan.startDate);
                const daysRemaining = Math.ceil((dueDate - currentGameTime) / (1000 * 60 * 60 * 24));
                
                return \`
                    <div class="loan-card">
                        <div class="loan-header">
                            <strong>Loan #\${loan.id} - \${loan.companyName}</strong>
                            <span>Balance: $\${loan.balance.toFixed(2)}</span>
                        </div>
                        <div class="loan-details">
                            <div class="loan-detail">Principal: $\${loan.principal.toFixed(2)}</div>
                            <div class="loan-detail">Interest Rate: \${(loan.interestRate * 100).toFixed(2)}%</div>
                            <div class="loan-detail">Started: \${startDate.toLocaleDateString()}</div>
                            <div class="loan-detail">Due: \${dueDate.toLocaleDateString()} (\${daysRemaining} days)</div>
                            <div class="loan-detail">Missed Payments: \${loan.missedPayments}</div>
                        </div>
                        <div class="payment-form">
                            <input type="number" id="payment-\${loan.id}" placeholder="Payment amount" min="1" step="0.01">
                            <button onclick="makePayment(\${loan.id})">Make Payment</button>
                            <button onclick="payOffLoan(\${loan.id}, \${loan.balance})">Pay Off</button>
                        </div>
                    </div>
                \`;
            }).join('');
        }

        async function loadCompanies() {
            const response = await fetch('/api/loans/companies');
            const companies = await response.json();
            
            const container = document.getElementById('companies');
            
            container.innerHTML = companies.map(company => {
                const trustClass = getTrustClass(company.trustLevel);
                const rate = (company.adjustedInterestRate * 100).toFixed(2);
                
                return \`
                    <div class="company-card">
                        <div class="company-header">
                            <strong>\${company.name}</strong>
                            <span class="trust-level \${trustClass}">Trust: \${company.trustLevel}/10</span>
                        </div>
                        <div class="company-details">
                            <div>\${company.description}</div>
                            <div><strong>Interest Rate:</strong> \${rate}% APR</div>
                            <div><strong>Loan Range:</strong> $\${company.minLoan.toLocaleString()} - $\${company.maxLoan.toLocaleString()}</div>
                            <div><strong>Term:</strong> \${company.termDays} days (\${Math.floor(company.termDays / 365)} years)</div>
                            <div><strong>Origination Fee:</strong> \${(company.originationFee * 100).toFixed(1)}%</div>
                            <div><strong>Late Penalty:</strong> \${(company.latePaymentPenalty * 100).toFixed(0)}%</div>
                            <div><strong>Min Credit Score:</strong> \${company.minCreditScore}</div>
                        </div>
                        <div class="loan-form">
                            <input type="number" id="amount-\${company.id}" placeholder="Amount" min="\${company.minLoan}" max="\${company.maxLoan}" step="100">
                            <button onclick="takeLoan('\${company.id}')">Apply</button>
                        </div>
                    </div>
                \`;
            }).join('');
        }

        async function takeLoan(companyId) {
            const amountInput = document.getElementById(\`amount-\${companyId}\`);
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 0) {
                showMessage('Please enter a valid loan amount', 'error');
                return;
            }
            
            const response = await fetch('/api/loans/take', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ companyId, amount })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showMessage(data.message, 'success');
                amountInput.value = '';
                loadAccountData();
                loadActiveLoans();
            } else {
                showMessage(data.error, 'error');
            }
        }

        async function makePayment(loanId) {
            const amountInput = document.getElementById(\`payment-\${loanId}\`);
            const amount = parseFloat(amountInput.value);
            
            if (!amount || amount <= 0) {
                showMessage('Please enter a valid payment amount', 'error');
                return;
            }
            
            const response = await fetch('/api/loans/pay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ loanId, amount })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showMessage(data.message, 'success');
                amountInput.value = '';
                loadAccountData();
                loadActiveLoans();
            } else {
                showMessage(data.error, 'error');
            }
        }

        async function payOffLoan(loanId, balance) {
            const response = await fetch('/api/loans/pay', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ loanId, amount: balance })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showMessage(data.message, 'success');
                loadAccountData();
                loadActiveLoans();
            } else {
                showMessage(data.error, 'error');
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = \`<div class="message \${type}">\${text}</div>\`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }

        // Load data on page load
        loadAccountData();
        loadActiveLoans();
        loadCompanies();
        
        // Refresh every 10 seconds
        setInterval(() => {
            loadAccountData();
            loadActiveLoans();
        }, 10000);
    </script>
    <script>
async function updateEraTheme() {
            const response = await fetch('/api/time');
            const data = await response.json();
            const gameDate = new Date(data.currentTime);
            const year = gameDate.getFullYear();
            applyEraTheme(year);
        }
        
        updateEraTheme();
        setInterval(updateEraTheme, 10000);
    </script>
    `
}) %>
