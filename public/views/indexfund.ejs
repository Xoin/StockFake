<%- include('partials/header', { 
    title: 'Index Fund',
    pageTitle: 'INDEX FUND'
}) %>

<!-- Shared header component -->
        <div id="shared-header" data-title="ðŸ“Š INDEX FUND"></div>
        
        <div class="fund-header" id="fundHeader">
            <div class="fund-symbol" id="fundSymbol">Loading...</div>
            <div class="fund-name" id="fundName">Loading...</div>
            <div id="fundDescription" style="color: #00aa00; margin-top: 10px;">Loading...</div>
            
            <div class="fund-info-grid">
                <div class="info-card">
                    <div class="info-label">Current Price</div>
                    <div class="info-value" id="currentPrice">$0.00</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Change (24h)</div>
                    <div class="info-value" id="priceChange">0.00%</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Expense Ratio</div>
                    <div class="info-value" id="expenseRatio">0.00%</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Holdings</div>
                    <div class="info-value" id="numConstituents">0 stocks</div>
                </div>
            </div>
        </div>
        
        <div class="chart-container">
            <h2>Price History</h2>
            <div class="time-range-selector">
                <button onclick="loadChart(7)" id="btn-7d">7 Days</button>
                <button onclick="loadChart(30)" id="btn-30d" class="active">30 Days</button>
                <button onclick="loadChart(90)" id="btn-90d">90 Days</button>
                <button onclick="loadChart(365)" id="btn-365d">1 Year</button>
            </div>
            <canvas id="priceChart"></canvas>
        </div>
        
        <div class="trade-section">
            <h2>Trade This Fund</h2>
            <div id="tradeMessage"></div>
            
            <div style="margin: 15px 0;">
                <label for="tradeAction">Action:</label>
                <select id="tradeAction">
                    <option value="buy">Buy</option>
                    <option value="sell">Sell</option>
                </select>
            </div>
            
            <div style="margin: 15px 0;">
                <label for="shares">Shares:</label>
                <input type="number" id="shares" min="0.01" step="0.01" value="1">
            </div>
            
            <div>
                <button id="executeTrade" onclick="executeTrade()" class="buy-btn">Execute Trade</button>
                <a href="/indexfunds" style="margin-left: 10px; color: #00ff00; text-decoration: none; border: 1px solid #00ff00; padding: 10px 20px; display: inline-block;">Back to All Funds</a>
            </div>
        </div>
        
        <div class="constituents-container">
            <h2>Top Holdings</h2>
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Current Price</th>
                        <th>Change</th>
                    </tr>
                </thead>
                <tbody id="constituentsList">
                    <tr><td colspan="3">Loading...</td></tr>
                </tbody>
            </table>
        </div>

<%- include('partials/footer', {
    pageScripts: `
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
let fundSymbol = null;
        let fundDetails = null;
        let priceChart = null;
        let currentDays = 30;
        
        // Get symbol from URL
        const urlParams = new URLSearchParams(window.location.search);
        fundSymbol = urlParams.get('symbol');
        
        if (!fundSymbol) {
            document.getElementById('fundHeader').innerHTML = 
                '<div class="message error">No fund symbol specified. <a href="/indexfunds" style="color: #ff0000;">Go back to index funds</a></div>';
        }
        
        async function loadFundDetails() {
            if (!fundSymbol) return;
            
            try {
                const response = await fetch(\`/api/indexfunds/\${fundSymbol}\`);
                if (!response.ok) {
                    throw new Error('Fund not found or not available yet');
                }
                
                fundDetails = await response.json();
                
                // Update header
                document.getElementById('fundSymbol').textContent = fundDetails.symbol;
                document.getElementById('fundName').textContent = fundDetails.name;
                document.getElementById('fundDescription').textContent = fundDetails.description;
                
                // Update info cards
                document.getElementById('currentPrice').textContent = \`$\${fundDetails.price.toFixed(2)}\`;
                
                const changeEl = document.getElementById('priceChange');
                const change = fundDetails.change || 0;
                changeEl.textContent = \`\${change >= 0 ? '+' : ''}\${change.toFixed(2)}%\`;
                changeEl.className = \`info-value \${change >= 0 ? 'positive' : 'negative'}\`;
                
                document.getElementById('expenseRatio').textContent = \`\${(fundDetails.expenseRatio * 100).toFixed(2)}%\`;
                document.getElementById('numConstituents').textContent = \`\${fundDetails.numConstituents} stocks\`;
                
                // Update constituents list
                const constituentsList = document.getElementById('constituentsList');
                if (fundDetails.constituents && fundDetails.constituents.length > 0) {
                    // Show top 20 holdings
                    const topHoldings = fundDetails.constituents.slice(0, 20);
                    constituentsList.innerHTML = topHoldings.map(stock => \`
                        <tr>
                            <td><a href="/company/\${escapeHtml(stock.symbol)}" style="color: #00ff00; text-decoration: none;">\${escapeHtml(stock.symbol)}</a></td>
                            <td>$\${stock.price.toFixed(2)}</td>
                            <td class="\${stock.change >= 0 ? 'positive' : 'negative'}">
                                \${stock.change >= 0 ? '+' : ''}\${stock.change.toFixed(2)}%
                            </td>
                        </tr>
                    \`).join('');
                } else {
                    constituentsList.innerHTML = '<tr><td colspan="3">No holdings data available</td></tr>';
                }
            } catch (error) {
                console.error('Error loading fund details:', error);
                document.getElementById('fundHeader').innerHTML = 
                    \`<div class="message error">Error: \${escapeHtml(error.message)}. <a href="/indexfunds" style="color: #ff0000;">Go back to index funds</a></div>\`;
            }
        }
        
        async function loadChart(days) {
            if (!fundSymbol) return;
            
            currentDays = days;
            
            // Update active button
            document.querySelectorAll('.time-range-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(\`btn-\${days}d\`).classList.add('active');
            
            try {
                const response = await fetch(\`/api/indexfunds/\${fundSymbol}/history?days=\${days}\`);
                const history = await response.json();
                
                if (!history || history.length === 0) {
                    console.warn('No history data available');
                    return;
                }
                
                const ctx = document.getElementById('priceChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (priceChart) {
                    priceChart.destroy();
                }
                
                priceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map(h => new Date(h.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Price',
                            data: history.map(h => h.price),
                            borderColor: '#00ff00',
                            backgroundColor: 'rgba(0, 255, 0, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                ticks: { color: '#00ff00', maxRotation: 45, minRotation: 45 },
                                grid: { color: '#003300' }
                            },
                            y: {
                                ticks: { color: '#00ff00', callback: (value) => '$' + value.toFixed(2) },
                                grid: { color: '#003300' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#00ff00' } },
                            tooltip: {
                                backgroundColor: '#000',
                                borderColor: '#00ff00',
                                borderWidth: 1,
                                titleColor: '#00ff00',
                                bodyColor: '#00ff00',
                                callbacks: {
                                    label: (context) => \`Price: $\${context.parsed.y.toFixed(2)}\`
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }
        
        async function executeTrade() {
            const action = document.getElementById('tradeAction').value;
            const shares = parseFloat(document.getElementById('shares').value);
            
            if (!fundSymbol || shares <= 0) {
                return;
            }
            
            const messageDiv = document.getElementById('tradeMessage');
            
            try {
                const response = await fetch('/api/indexfunds/trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: fundSymbol,
                        shares: shares,
                        action: action
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    messageDiv.innerHTML = \`<div class="message success">\${result.message || 'Trade executed successfully!'}</div>\`;
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                } else {
                    messageDiv.innerHTML = \`<div class="message error">\${escapeHtml(result.error)}</div>\`;
                }
            } catch (error) {
                messageDiv.innerHTML = \`<div class="message error">Error: \${escapeHtml(error.message)}</div>\`;
            }
        }
        
        // Initialize
        if (fundSymbol) {
            loadFundDetails();
            loadChart(30);
        }
    </script>
    `
}) %>
