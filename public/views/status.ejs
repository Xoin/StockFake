<%- include('partials/header', { 
    title: 'Server Status',
    pageTitle: 'üñ•Ô∏è SERVER STATUS & PERFORMANCE',
    pageStyles: `
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-card {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
        }
        .status-card h2 {
            color: #00ff00;
            margin-top: 0;
            font-size: 18px;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #001100;
        }
        .metric-label {
            color: #00aa00;
        }
        .metric-value {
            color: #00ff00;
            font-weight: bold;
        }
        .status-good {
            color: #00ff00 !important;
        }
        .status-warning {
            color: #ffaa00 !important;
        }
        .status-error {
            color: #ff0000 !important;
        }
        .refresh-button {
            background-color: #003300;
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
        }
        .refresh-button:hover {
            background-color: #004400;
        }
        .log-container {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            color: #00aa00;
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        .auto-refresh-toggle {
            margin-left: 10px;
            cursor: pointer;
        }
    `
}) %>

<div>
    <button class="refresh-button" onclick="refreshStatus()">üîÑ Refresh Now</button>
    <label class="auto-refresh-toggle">
        <input type="checkbox" id="autoRefreshCheckbox" checked onchange="toggleAutoRefresh()">
        Auto-refresh (10s)
    </label>
</div>

<div class="status-grid">
    <div class="status-card">
        <h2>‚è±Ô∏è System Status</h2>
        <div class="metric">
            <span class="metric-label">Server Uptime:</span>
            <span class="metric-value" id="uptime">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Game Status:</span>
            <span class="metric-value" id="gameStatus">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Game Time:</span>
            <span class="metric-value" id="gameTime">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Time Multiplier:</span>
            <span class="metric-value" id="timeMultiplier">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Market Status:</span>
            <span class="metric-value" id="marketStatus">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Memory Usage:</span>
            <span class="metric-value" id="memoryUsage">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Memory Limit:</span>
            <span class="metric-value" id="memoryLimit">Loading...</span>
        </div>
    </div>

    <div class="status-card">
        <h2>üìä Game Metrics</h2>
        <div class="metric">
            <span class="metric-label">Available Stocks:</span>
            <span class="metric-value" id="stockCount">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Available Index Funds:</span>
            <span class="metric-value" id="indexFundCount">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Active Loans:</span>
            <span class="metric-value" id="loanCount">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Total Transactions:</span>
            <span class="metric-value" id="transactionCount">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Pending Orders:</span>
            <span class="metric-value" id="pendingOrderCount">Loading...</span>
        </div>
    </div>

    <div class="status-card">
        <h2>üí∞ Account Health</h2>
        <div class="metric">
            <span class="metric-label">Cash Balance:</span>
            <span class="metric-value" id="cashBalance">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Portfolio Value:</span>
            <span class="metric-value" id="portfolioValue">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Total Net Worth:</span>
            <span class="metric-value" id="netWorth">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Credit Score:</span>
            <span class="metric-value" id="creditScore">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Margin Debt:</span>
            <span class="metric-value" id="marginDebt">Loading...</span>
        </div>
    </div>

    <div class="status-card">
        <h2>‚ö° Performance</h2>
        <div class="metric">
            <span class="metric-label">API Response Time:</span>
            <span class="metric-value" id="apiResponseTime">Loading...</span>
        </div>
        <div class="metric">
            <span class="metric-label">Last Update:</span>
            <span class="metric-value" id="lastUpdate">Never</span>
        </div>
        <div class="metric">
            <span class="metric-label">Update Status:</span>
            <span class="metric-value status-good" id="updateStatus">Ready</span>
        </div>
    </div>
</div>

<div class="status-card">
    <h2>üìù Recent Activity Log</h2>
    <div class="log-container" id="activityLog">
        <div class="log-entry">No recent activity</div>
    </div>
</div>

<%- include('partials/footer', {
    pageScripts: `
    <script>
let autoRefresh = true;
        let refreshInterval = null;
        
        function formatCurrency(value) {
            return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return \`\${days}d \${hours % 24}h\`;
            if (hours > 0) return \`\${hours}h \${minutes % 60}m\`;
            if (minutes > 0) return \`\${minutes}m \${seconds % 60}s\`;
            return \`\${seconds}s\`;
        }
        
        async function refreshStatus() {
            const startTime = Date.now();
            
            try {
                document.getElementById('updateStatus').textContent = 'Updating...';
                document.getElementById('updateStatus').className = 'metric-value status-warning';
                
                // Fetch all data in parallel
                const [timeData, accountData, stocksData, indexFundsData, pendingOrdersData] = await Promise.all([
                    fetch('/api/time').then(r => r.json()),
                    fetch('/api/account').then(r => r.json()),
                    fetch('/api/stocks').then(r => r.json()),
                    fetch('/api/indexfunds').then(r => r.json()),
                    fetch('/api/pendingorders/status/pending').then(r => r.json())
                ]);
                
                const responseTime = Date.now() - startTime;
                
                // System Status
                document.getElementById('uptime').textContent = formatUptime(Date.now() - new Date(timeData.currentTime).getTime());
                document.getElementById('gameStatus').textContent = timeData.isPaused ? '‚è∏Ô∏è Paused' : '‚ñ∂Ô∏è Running';
                document.getElementById('gameStatus').className = timeData.isPaused ? 'metric-value status-warning' : 'metric-value status-good';
                document.getElementById('gameTime').textContent = new Date(timeData.currentTime).toLocaleString();
                
                // Time multiplier with friendly labels
                let speedLabel = '';
                if (timeData.timeMultiplier === 60) speedLabel = ' (Slow: 1s = 1min)';
                else if (timeData.timeMultiplier === 3600) speedLabel = ' (Normal: 1s = 1hr)';
                else if (timeData.timeMultiplier === 86400) speedLabel = ' (Fast: 1s = 1day)';
                else speedLabel = \` (Custom: 1s = \${Math.floor(timeData.timeMultiplier/60)}min)\`;
                document.getElementById('timeMultiplier').textContent = timeData.timeMultiplier + speedLabel;
                
                document.getElementById('marketStatus').textContent = timeData.isMarketOpen ? 'üü¢ Open' : 'üî¥ Closed';
                document.getElementById('marketStatus').className = timeData.isMarketOpen ? 'metric-value status-good' : 'metric-value status-error';
                
                // Memory information (client-side approximation since server doesn't provide it yet)
                if (performance && performance.memory) {
                    const memUsedMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                    const memLimitMB = (performance.memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2);
                    const memPercent = ((performance.memory.usedJSHeapSize / performance.memory.jsHeapSizeLimit) * 100).toFixed(1);
                    
                    document.getElementById('memoryUsage').textContent = \`\${memUsedMB} MB (\${memPercent}%)\`;
                    document.getElementById('memoryLimit').textContent = \`\${memLimitMB} MB\`;
                    
                    // Color code based on usage percentage
                    const memClass = memPercent < 50 ? 'metric-value status-good' : 
                                     memPercent < 80 ? 'metric-value status-warning' : 
                                     'metric-value status-error';
                    document.getElementById('memoryUsage').className = memClass;
                } else {
                    document.getElementById('memoryUsage').textContent = 'N/A';
                    document.getElementById('memoryLimit').textContent = 'N/A';
                }
                
                // Game Metrics
                document.getElementById('stockCount').textContent = stocksData.length;
                document.getElementById('indexFundCount').textContent = indexFundsData.length;
                document.getElementById('loanCount').textContent = accountData.loans.filter(l => l.status === 'active').length;
                document.getElementById('transactionCount').textContent = accountData.transactions.length;
                document.getElementById('pendingOrderCount').textContent = pendingOrdersData.length;
                
                // Account Health
                document.getElementById('cashBalance').textContent = formatCurrency(accountData.cash);
                document.getElementById('cashBalance').className = accountData.cash >= 0 ? 'metric-value status-good' : 'metric-value status-error';
                
                const portfolioValue = accountData.portfolioMetrics.portfolioValue;
                document.getElementById('portfolioValue').textContent = formatCurrency(portfolioValue);
                
                const netWorth = accountData.portfolioMetrics.accountEquity;
                document.getElementById('netWorth').textContent = formatCurrency(netWorth);
                document.getElementById('netWorth').className = netWorth >= 0 ? 'metric-value status-good' : 'metric-value status-error';
                
                document.getElementById('creditScore').textContent = accountData.creditScore;
                let creditClass = 'metric-value ';
                if (accountData.creditScore >= 750) creditClass += 'status-good';
                else if (accountData.creditScore >= 650) creditClass += 'status-warning';
                else creditClass += 'status-error';
                document.getElementById('creditScore').className = creditClass;
                
                document.getElementById('marginDebt').textContent = formatCurrency(accountData.marginAccount.marginBalance);
                document.getElementById('marginDebt').className = accountData.marginAccount.marginBalance > 0 ? 'metric-value status-warning' : 'metric-value status-good';
                
                // Performance
                document.getElementById('apiResponseTime').textContent = responseTime + 'ms';
                document.getElementById('apiResponseTime').className = responseTime < 500 ? 'metric-value status-good' : 
                                                                       responseTime < 1000 ? 'metric-value status-warning' : 
                                                                       'metric-value status-error';
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                document.getElementById('updateStatus').textContent = 'Updated';
                document.getElementById('updateStatus').className = 'metric-value status-good';
                
                // Activity Log
                updateActivityLog(accountData.transactions.slice(-10).reverse());
                
            } catch (error) {
                console.error('Error refreshing status:', error);
                document.getElementById('updateStatus').textContent = 'Error';
                document.getElementById('updateStatus').className = 'metric-value status-error';
            }
        }
        
        function updateActivityLog(transactions) {
            const logContainer = document.getElementById('activityLog');
            if (transactions.length === 0) {
                logContainer.innerHTML = '<div class="log-entry">No recent activity</div>';
                return;
            }
            
            logContainer.innerHTML = transactions.map(tx => {
                const time = new Date(tx.date).toLocaleTimeString();
                let description = '';
                
                if (tx.type === 'buy') {
                    description = \`Bought \${tx.shares} shares of \${tx.symbol} at \${formatCurrency(tx.pricePerShare)}\`;
                } else if (tx.type === 'sell') {
                    description = \`Sold \${tx.shares} shares of \${tx.symbol} at \${formatCurrency(tx.pricePerShare)}\${tx.automatic ? ' (AUTOMATIC)' : ''}\`;
                } else if (tx.type === 'buy-indexfund') {
                    description = \`Bought \${tx.shares} shares of \${tx.symbol} index fund\`;
                } else if (tx.type === 'sell-indexfund') {
                    description = \`Sold \${tx.shares} shares of \${tx.symbol} index fund\`;
                } else if (tx.type === 'margin-payment') {
                    description = \`Margin payment: \${formatCurrency(tx.amount)}\`;
                } else {
                    description = \`\${tx.type}: \${tx.symbol || ''}\`;
                }
                
                return \`<div class="log-entry">[\${time}] \${description}</div>\`;
            }).join('');
        }
        
        function toggleAutoRefresh() {
            autoRefresh = document.getElementById('autoRefreshCheckbox').checked;
            if (autoRefresh) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        }
        
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(refreshStatus, 10000);
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        // Initial load
        refreshStatus();
        
        // Start auto-refresh
        if (autoRefresh) {
            startAutoRefresh();
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', stopAutoRefresh);
    </script>
    <script>
async function updateEraTheme() {
            const response = await fetch('/api/time');
            const data = await response.json();
            const gameDate = new Date(data.currentTime);
            const year = gameDate.getFullYear();
            applyEraTheme(year);
        }
        
        updateEraTheme();
        setInterval(updateEraTheme, 10000);
    </script>
    `
}) %>
