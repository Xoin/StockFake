<%- include('partials/header', { 
    title: 'News',
    pageTitle: 'üì∞ FINANCIAL TIMES',
    pageStyles: `
        .newspaper-header {
            background-color: #000;
            border: 3px double #00ff00;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .newspaper-masthead {
            font-size: 2.5em;
            font-weight: bold;
            color: #00ff00;
            letter-spacing: 3px;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }
        .newspaper-tagline {
            color: #00aa00;
            font-size: 0.9em;
            font-style: italic;
            margin-bottom: 10px;
        }
        .newspaper-date {
            color: #00ff00;
            font-size: 1.1em;
            border-top: 1px solid #00ff00;
            border-bottom: 1px solid #00ff00;
            padding: 5px 0;
            margin-top: 10px;
        }
        .news-container {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
        }
        .news-columns {
            column-count: 1;
            column-gap: 20px;
        }
        @media (min-width: 768px) {
            .news-columns {
                column-count: 2;
            }
        }
        .news-article {
            background-color: #001100;
            border: 1px solid #003300;
            margin-bottom: 20px;
            padding: 15px;
            break-inside: avoid;
            page-break-inside: avoid;
        }
        .news-article.featured {
            border: 2px solid #00ff00;
            background-color: #002200;
        }
        .news-article.unread {
            border-left: 4px solid #00ff00;
        }
        .article-category {
            color: #00aa00;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .article-headline {
            color: #00ff00;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .article-date {
            color: #00aa00;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        .article-body {
            color: #00cc00;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .article-footer {
            border-top: 1px solid #003300;
            padding-top: 8px;
            margin-top: 10px;
            font-size: 0.85em;
            color: #00aa00;
        }
        .no-news {
            text-align: center;
            padding: 30px;
            color: #00aa00;
        }
        .pagination-controls-container {
            margin: 15px 0;
        }
        .filter-section {
            background-color: #001100;
            border: 1px solid #003300;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-section label {
            color: #00ff00;
        }
        .filter-section select {
            background-color: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 5px 10px;
            font-family: 'Courier New', monospace;
        }
    `
}) %>
        
        <div class="newspaper-header">
            <div class="newspaper-masthead">üì∞ The Financial Times üì∞</div>
            <div class="newspaper-tagline">"All The Market News That's Fit To Print"</div>
            <div class="newspaper-date" id="newspaperDate">Loading...</div>
        </div>
        
        <div class="filter-section">
            <label for="categoryFilter">Category:</label>
            <select id="categoryFilter" onchange="renderNewsPage()">
                <option value="all">All News</option>
                <option value="market">Market News</option>
                <option value="historical">Historical Events</option>
            </select>
            <label style="margin-left: 20px;">
                <input type="checkbox" id="unreadOnly" onchange="renderNewsPage()"> 
                Show Unread Only
            </label>
        </div>
        
        <div class="pagination-controls-container"></div>
        <div class="news-container">
            <div class="news-columns" id="newsContainer">
                <div class="no-news">Loading news...</div>
            </div>
        </div>
        <div class="pagination-controls-container"></div>

<%- include('partials/footer', {
    pageScripts: `
    <script>
let paginator;
        let allNews = [];
        let readNewsIds = new Set(JSON.parse(localStorage.getItem('readNewsIds') || '[]'));
        
        // Mark news as read
        function markNewsAsRead(newsId) {
            readNewsIds.add(newsId);
            localStorage.setItem('readNewsIds', JSON.stringify([...readNewsIds]));
        }
        
        // Determine if news is dynamic (market movement) or historical
        function getNewsCategory(newsItem) {
            // Dynamic news typically has IDs >= 10000
            if (newsItem.id >= 10000) return 'market';
            return 'historical';
        }
        
        // Render news article in newspaper style
        function renderArticle(newsItem, index) {
            const isUnread = !readNewsIds.has(newsItem.id);
            const category = getNewsCategory(newsItem);
            const isFeatured = index === 0; // First article is featured
            
            const categoryLabel = category === 'market' ? 'üìä Market Update' : 'üìú Historical';
            
            const article = \`
                <div class="news-article \${isFeatured ? 'featured' : ''} \${isUnread ? 'unread' : ''}" 
                     onclick="markNewsAsRead(\${newsItem.id}); this.classList.remove('unread');">
                    <div class="article-category">\${categoryLabel}</div>
                    <div class="article-headline">\${escapeHtml(newsItem.headline)}</div>
                    <div class="article-date">\${new Date(newsItem.date).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                    <div class="article-body">\${escapeHtml(newsItem.body)}</div>
                    \${isUnread ? '<div class="article-footer">‚óè New</div>' : ''}
                </div>
            \`;
            
            return article;
        }
        
        // Render current page of news
        function renderNewsPage() {
            if (!paginator) return;
            
            const categoryFilter = document.getElementById('categoryFilter').value;
            const unreadOnly = document.getElementById('unreadOnly').checked;
            
            // Filter news
            let filteredNews = allNews;
            
            if (categoryFilter !== 'all') {
                filteredNews = filteredNews.filter(item => getNewsCategory(item) === categoryFilter);
            }
            
            if (unreadOnly) {
                filteredNews = filteredNews.filter(item => !readNewsIds.has(item.id));
            }
            
            // Update paginator with filtered items
            paginator.updateItems(filteredNews);
            
            const currentPage = paginator.getCurrentPage();
            const container = document.getElementById('newsContainer');
            
            if (currentPage.length === 0) {
                container.innerHTML = '<div class="no-news">No news articles match your filter.</div>';
                return;
            }
            
            container.innerHTML = currentPage.map((item, index) => renderArticle(item, index)).join('');
        }
        
        // Fetch and display news
        async function fetchNews() {
            try {
                const [newsResponse, timeResponse] = await Promise.all([
                    fetch('/api/news'),
                    fetch('/api/time')
                ]);
                
                allNews = await newsResponse.json();
                const timeData = await timeResponse.json();
                const gameDate = new Date(timeData.currentTime);
                
                // Update newspaper date
                document.getElementById('newspaperDate').textContent = gameDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Initialize paginator with 10 items per page (reduced from default)
                if (!paginator) {
                    paginator = createPaginator(allNews, 10, renderNewsPage);
                } else {
                    paginator.updateItems(allNews);
                }
                
                renderNewsPage();
            } catch (error) {
                console.error('Error fetching news:', error);
                document.getElementById('newsContainer').innerHTML = 
                    '<div class="no-news">Error loading news. Please try again.</div>';
            }
        }
        
        // Initial fetch
        fetchNews();
        
        // Refresh periodically
        setInterval(fetchNews, 10000); // Every 10 seconds
    </script>
    <script>
async function updateEraTheme() {
            const response = await fetch('/api/time');
            const data = await response.json();
            const gameDate = new Date(data.currentTime);
            const year = gameDate.getFullYear();
            applyEraTheme(year);
        }
        
        updateEraTheme();
        setInterval(updateEraTheme, 10000);
    </script>
    `
}) %>
