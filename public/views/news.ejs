<%- include('partials/header', { 
    title: 'News',
    pageTitle: 'ðŸ“° FINANCIAL NEWS'
}) %>

<!-- Shared header component - auto-loads via header.js -->
        <div id="shared-header" data-title="ðŸ“° HISTORICAL NEWS"></div>
        
        <div class="pagination-controls-container"></div>
        <div class="news-container" id="newsContainer">
            <div class="no-news">Loading news...</div>
        </div>
        <div class="pagination-controls-container"></div>

<%- include('partials/footer', {
    pageScripts: `
    <script>
let paginator;
        let allNews = [];
        let readNewsIds = new Set(JSON.parse(localStorage.getItem('readNewsIds') || '[]'));
        let expandedNewsIds = new Set();
        
        // Toggle news item expansion
        function toggleNews(newsId) {
            if (expandedNewsIds.has(newsId)) {
                expandedNewsIds.delete(newsId);
            } else {
                expandedNewsIds.add(newsId);
                // Mark as read when expanded
                markNewsAsRead(newsId);
            }
            renderNewsPage();
        }
        
        // Mark news as read
        function markNewsAsRead(newsId) {
            readNewsIds.add(newsId);
            localStorage.setItem('readNewsIds', JSON.stringify([...readNewsIds]));
            // Don't re-render to avoid collapsing expanded items
        }
        
        // Format market update body as a table
        function formatMarketUpdateTable(bodyText) {
            // Parse numbered list format: "1. Company (SYMBOL) text... 2. Company text..."
            const items = bodyText.split(/\d+\.\s+/).filter(item => item.trim());
            
            if (items.length === 0) {
                return \`<div class="news-body">\${escapeHtml(bodyText)}</div>\`;
            }
            
            // Parse each item to extract stock info and movement
            const movements = items.map(item => {
                // Try to extract company name, symbol, and change percentage
                const symbolMatch = item.match(/\(([A-Z]+)\)/);
                const changeMatch = item.match(/(gained|advanced|declined|lost|moved|up|down)\s+([\d.]+)%/i);
                const upMatch = item.match(/(surges|surged|jump|jumped|rally|rallied|gains|gained|advanced)/i);
                const downMatch = item.match(/(plunges|plunged|drop|dropped|decline|declined|losses|lost|tumbled)/i);
                
                let symbol = symbolMatch ? symbolMatch[1] : '';
                let change = changeMatch ? parseFloat(changeMatch[2]) : 0;
                
                // Determine direction from text if not in change match
                if (upMatch && change === 0) {
                    const percentMatch = item.match(/([\d.]+)%/);
                    if (percentMatch) change = parseFloat(percentMatch[1]);
                }
                if (downMatch && change === 0) {
                    const percentMatch = item.match(/([\d.]+)%/);
                    if (percentMatch) change = -parseFloat(percentMatch[1]);
                }
                
                // Extract company name (text before symbol or first few words)
                let company = item;
                if (symbolMatch) {
                    company = item.substring(0, item.indexOf('(')).trim();
                } else {
                    company = item.split(/\s+/).slice(0, 3).join(' ');
                }
                
                // Clean up company name
                company = company.replace(/^(Shares of|Investors|Market)\s+/i, '').trim();
                
                return { company, symbol, change, text: item.trim() };
            });
            
            let tableHtml = \`
                <div class="news-body">
                    <table class="market-update-table">
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Symbol</th>
                                <th>Change</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
            \`;
            
            movements.forEach(m => {
                const changeClass = m.change >= 0 ? 'positive-change' : 'negative-change';
                const changeSymbol = m.change >= 0 ? 'â–²' : 'â–¼';
                const changeText = m.change !== 0 ? \`\${escapeHtml(changeSymbol)} \${Math.abs(m.change).toFixed(1)}%\` : 'N/A';
                
                tableHtml += \`
                    <tr>
                        <td>\${escapeHtml(m.company)}</td>
                        <td>\${escapeHtml(m.symbol)}</td>
                        <td class="\${changeClass}">\${changeText}</td>
                        <td>\${escapeHtml(m.text.substring(0, 100))}\${m.text.length > 100 ? '...' : ''}</td>
                    </tr>
                \`;
            });
            
            tableHtml += \`
                        </tbody>
                    </table>
                </div>
            \`;
            
            return tableHtml;
        }
        
        // Pagination render function - used by pagination controls in common.js
        function renderPage() {
            renderNewsPage();
        }
        
        async function renderNewsPage() {
            if (!paginator) return;
            
            const pageNews = paginator.getCurrentPageItems();
            const container = document.getElementById('newsContainer');
            
            if (pageNews.length === 0 && allNews.length === 0) {
                container.innerHTML = '<div class="no-news">No news available yet. Major events will appear as time progresses.</div>';
            } else if (pageNews.length === 0) {
                container.innerHTML = '<div class="no-news">No items on this page.</div>';
            } else {
                container.innerHTML = pageNews.map(item => {
                    const isUnread = !readNewsIds.has(item.id);
                    const isExpanded = expandedNewsIds.has(item.id);
                    const unreadClass = isUnread ? 'unread' : '';
                    const expandedClass = isExpanded ? 'expanded' : '';
                    const isMarketUpdate = item.headline && item.headline.includes('Market Update');
                    const marketUpdateClass = isMarketUpdate ? 'market-update' : '';
                    
                    // Format body - parse market updates into table format
                    let bodyHtml = '';
                    if (isMarketUpdate && item.body) {
                        bodyHtml = formatMarketUpdateTable(item.body);
                    } else {
                        bodyHtml = \`<div class="news-body">\${escapeHtml(item.body)}</div>\`;
                    }
                    
                    return \`
                        <div class="news-item \${unreadClass} \${expandedClass} \${marketUpdateClass}" onclick="toggleNews(\${item.id})">
                            <div class="news-date">\${new Date(item.date).toLocaleDateString()}</div>
                            <div class="news-headline">\${escapeHtml(item.headline)}</div>
                            \${bodyHtml}
                        </div>
                    \`;
                }).join('');
            }
            
            // Update pagination controls
            const paginationDivs = document.querySelectorAll('.pagination-controls-container');
            paginationDivs.forEach(div => {
                div.innerHTML = paginator.renderControls();
            });
        }
        
        async function updateNews() {
            const response = await fetch('/api/news');
            const rawNews = await response.json();
            
            // Merge multiple dynamic news items from the same day
            const newsById = new Map();
            const dynamicNewsByDate = new Map();
            
            rawNews.forEach(item => {
                // Check if it's dynamic news (id >= 10000)
                if (item.id >= 10000) {
                    const dateKey = new Date(item.date).toDateString();
                    if (!dynamicNewsByDate.has(dateKey)) {
                        dynamicNewsByDate.set(dateKey, []);
                    }
                    dynamicNewsByDate.get(dateKey).push(item);
                } else {
                    newsById.set(item.id, item);
                }
            });
            
            // Merge dynamic news items by date
            dynamicNewsByDate.forEach((items, dateKey) => {
                if (items.length > 1) {
                    // Create merged news item with formatted list
                    const mergedItem = {
                        id: items[0].id, // Use first ID
                        date: items[0].date,
                        headline: 'Market Update: Multiple Stock Movements',
                        body: items.map((item, idx) => \`\${idx + 1}. \${item.body}\`).join('\n')
                    };
                    newsById.set(mergedItem.id, mergedItem);
                } else {
                    newsById.set(items[0].id, items[0]);
                }
            });
            
            allNews = Array.from(newsById.values()).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Update localStorage with current count for badge
            localStorage.setItem('lastNewsCount', allNews.length);
            
            paginator = new Paginator(allNews, 10);
            renderNewsPage();
        }
        
        updateNews();
        setInterval(updateNews, 5000);
    </script>
    `
}) %>
