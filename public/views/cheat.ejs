<%- include('partials/header', { 
    title: 'Debug Panel',
    pageTitle: 'üéÆ DEBUG PANEL',
    pageStyles: `
        .warning {
            background-color: #331100;
            border: 2px solid #ff8800;
            color: #ffaa00;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        .panel {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
        }
        .panel h2 {
            color: #00ff00;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #003300;
        }
        .info-display {
            background-color: #001100;
            border: 1px solid #003300;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }
        .info-display div {
            margin: 5px 0;
        }
        .control-group {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .control-group label {
            color: #00aa00;
            min-width: 120px;
        }
        .control-group input[type="number"],
        .control-group input[type="text"],
        .control-group input[type="datetime-local"] {
            background-color: #001100;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px;
            font-family: 'Courier New', monospace;
            flex: 1;
            min-width: 150px;
        }
        .control-group button,
        .button-group button {
            background-color: #003300;
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 8px 16px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: background-color 0.2s;
        }
        .control-group button:hover,
        .button-group button:hover {
            background-color: #004400;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .debug-json {
            background-color: #001100;
            border: 1px solid #003300;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .message {
            padding: 15px;
            margin: 15px 0;
            border: 2px solid;
            font-weight: bold;
        }
        .message.success {
            background-color: #001100;
            border-color: #00ff00;
            color: #00ff00;
        }
        .message.error {
            background-color: #110000;
            border-color: #ff0000;
            color: #ff0000;
        }
    `
}) %>

<div class="warning">
            ‚ö†Ô∏è WARNING: This page is for debugging purposes only. Changes made here can break your game state!
        </div>

        <div id="message"></div>

        <!-- Time Controls -->
        <div class="panel">
            <h2>‚è∞ Time Controls</h2>
            <div class="info-display" id="currentTimeDisplay">Loading...</div>
            
            <div class="control-group">
                <label>Jump to Date:</label>
                <input type="datetime-local" id="jumpToDate">
                <button onclick="jumpToDate()">Jump</button>
            </div>
            
            <div class="button-group">
                <button onclick="skipTime(1, 'hour')">+1 Hour</button>
                <button onclick="skipTime(1, 'day')">+1 Day</button>
                <button onclick="skipTime(7, 'day')">+1 Week</button>
                <button onclick="skipTime(30, 'day')">+1 Month</button>
                <button onclick="skipTime(365, 'day')">+1 Year</button>
                <button onclick="skipTime(10, 'year')">+10 Years</button>
            </div>
        </div>

        <!-- Account Manipulation -->
        <div class="panel">
            <h2>üí∞ Account Manipulation</h2>
            <div class="info-display" id="accountDisplay">Loading...</div>
            
            <div class="control-group">
                <label>Add Cash:</label>
                <input type="number" id="addCash" value="10000" step="1000">
                <button onclick="modifyCash()">Add Cash</button>
            </div>
            
            <div class="control-group">
                <label>Set Credit Score:</label>
                <input type="number" id="creditScore" value="750" min="300" max="850">
                <button onclick="setCreditScore()">Set Score</button>
            </div>
            
            <div class="button-group">
                <button onclick="modifyCash(100000)">+$100,000</button>
                <button onclick="modifyCash(1000000)">+$1,000,000</button>
                <button class="danger" onclick="modifyCash(-1000000)">-$1,000,000</button>
                <button class="danger" onclick="clearAllHoldings()">Clear All Holdings</button>
            </div>
        </div>

        <!-- Stock Manipulation -->
        <div class="panel">
            <h2>üìà Stock Manipulation</h2>
            
            <div class="control-group">
                <label>Stock Symbol:</label>
                <input type="text" id="stockSymbol" placeholder="e.g., IBM">
            </div>
            
            <div class="control-group">
                <label>Shares:</label>
                <input type="number" id="stockShares" value="100" min="1">
            </div>
            
            <div class="button-group">
                <button onclick="addStock()">Add to Portfolio</button>
                <button class="danger" onclick="removeStock()">Remove from Portfolio</button>
            </div>
        </div>

        <!-- Market Controls -->
        <div class="panel">
            <h2>üéÆ Game State</h2>
            
            <div class="button-group">
                <button onclick="togglePause()">Toggle Pause</button>
                <button onclick="setSpeed(60)">Slow Speed</button>
                <button onclick="setSpeed(3600)">Normal Speed</button>
                <button onclick="setSpeed(86400)">Fast Speed</button>
            </div>
            
            <div class="button-group">
                <button class="danger" onclick="resetGame()">Reset Game (Careful!)</button>
                <button onclick="refreshAll()">Refresh Data</button>
            </div>
            
            <div class="control-group">
                <label>Force Era Theme:</label>
                <select id="forceEraSelect">
                    <option value="">Auto (based on game year)</option>
                    <option value="1970s">1970s - Terminal Green</option>
                    <option value="1980s">1980s - Amber/Cyan CRT</option>
                    <option value="1990s">1990s - Web 1.0</option>
                    <option value="2000s">2000s - Web 2.0</option>
                    <option value="2010s">2010s - Flat Design</option>
                    <option value="2020s">2020s - Modern</option>
                </select>
                <button onclick="forceEraTheme()">Apply Theme</button>
            </div>
        </div>

        <!-- Information Display -->
        <div class="panel">
            <h2>üìä Debug Information</h2>
            <div class="info-display" id="debugInfo">
                <pre id="debugData">Loading...</pre>
            </div>
            <button onclick="updateDebugInfo()">Refresh Debug Info</button>
        </div>

<%- include('partials/footer', {
    pageScripts: `
    <script>
// Helper to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showMessage(text, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = \`<div class="message \${type}">\${escapeHtml(text)}</div>\`;
            setTimeout(() => messageDiv.innerHTML = '', 5000);
        }

        async function updateTimeDisplay() {
            try {
                const response = await fetch('/api/time');
                const data = await response.json();
                const date = new Date(data.currentTime);
                const status = data.isMarketOpen ? 'üü¢ MARKET OPEN' : 'üî¥ MARKET CLOSED';
                const pauseStatus = data.isPaused ? '‚è∏ PAUSED' : '‚ñ∂ RUNNING';
                
                document.getElementById('currentTimeDisplay').innerHTML = \`
                    Current Time: \${date.toLocaleString()}<br>
                    Status: \${status} | \${pauseStatus}<br>
                    Speed: \${data.timeMultiplier}x (\${getSpeedName(data.timeMultiplier)})
                \`;
            } catch (error) {
                console.error('Error updating time:', error);
            }
        }

        function getSpeedName(multiplier) {
            if (multiplier === 60) return '1s = 1min';
            if (multiplier === 3600) return '1s = 1hr';
            if (multiplier === 86400) return '1s = 1day';
            return 'custom';
        }

        async function updateAccountDisplay() {
            try {
                const response = await fetch('/api/account');
                const data = await response.json();
                
                document.getElementById('accountDisplay').innerHTML = \`
                    Cash: $\${data.cash.toLocaleString()}<br>
                    Credit Score: \${data.creditScore}<br>
                    Portfolio Value: $\${(data.portfolioValue || 0).toLocaleString()}<br>
                    Total Assets: $\${(data.totalAssets || 0).toLocaleString()}
                \`;
            } catch (error) {
                console.error('Error updating account:', error);
            }
        }

        async function jumpToDate() {
            const dateInput = document.getElementById('jumpToDate').value;
            if (!dateInput) {
                showMessage('Please select a date and time', 'error');
                return;
            }

            try {
                const targetDate = new Date(dateInput);
                
                // Validate the date
                if (isNaN(targetDate.getTime())) {
                    showMessage('Invalid date format', 'error');
                    return;
                }
                
                const response = await fetch('/api/debug/settime', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ time: targetDate.toISOString() })
                });

                if (response.ok) {
                    showMessage('Time jumped successfully!');
                    updateTimeDisplay();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to jump time', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function skipTime(amount, unit) {
            try {
                const response = await fetch('/api/debug/skiptime', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, unit })
                });

                if (response.ok) {
                    showMessage(\`Skipped \${amount} \${unit}(s)!\`);
                    updateTimeDisplay();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to skip time', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function modifyCash(amount) {
            if (!amount) {
                amount = parseFloat(document.getElementById('addCash').value);
            }
            
            try {
                const response = await fetch('/api/debug/modifycash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                });

                if (response.ok) {
                    showMessage(\`Cash \${amount > 0 ? 'added' : 'removed'}: $\${Math.abs(amount).toLocaleString()}\`);
                    updateAccountDisplay();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to modify cash', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function setCreditScore() {
            const score = parseInt(document.getElementById('creditScore').value);
            
            try {
                const response = await fetch('/api/debug/setcreditscore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ score })
                });

                if (response.ok) {
                    showMessage(\`Credit score set to \${score}\`);
                    updateAccountDisplay();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to set credit score', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function addStock() {
            const symbol = document.getElementById('stockSymbol').value.toUpperCase();
            const shares = parseInt(document.getElementById('stockShares').value);

            if (!symbol || !shares) {
                showMessage('Please enter symbol and shares', 'error');
                return;
            }

            try {
                const response = await fetch('/api/debug/addstock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, shares })
                });

                if (response.ok) {
                    showMessage(\`Added \${shares} shares of \${symbol}\`);
                    updateAccountDisplay();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to add stock', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function removeStock() {
            const symbol = document.getElementById('stockSymbol').value.toUpperCase();

            if (!symbol) {
                showMessage('Please enter a symbol', 'error');
                return;
            }

            try {
                const response = await fetch('/api/debug/removestock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });

                if (response.ok) {
                    showMessage(\`Removed \${symbol} from portfolio\`);
                    updateAccountDisplay();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to remove stock', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function clearAllHoldings() {
            if (!confirm('Are you sure you want to clear ALL holdings? This cannot be undone!')) {
                return;
            }

            try {
                const response = await fetch('/api/debug/clearholdings', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessage('All holdings cleared');
                    updateAccountDisplay();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to clear holdings', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function togglePause() {
            try {
                await fetch('/api/time/pause', { method: 'POST' });
                showMessage('Pause toggled');
                updateTimeDisplay();
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function setSpeed(multiplier) {
            try {
                await fetch('/api/time/speed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ multiplier })
                });
                showMessage(\`Speed set to \${getSpeedName(multiplier)}\`);
                updateTimeDisplay();
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function resetGame() {
            if (!confirm('Are you ABSOLUTELY SURE you want to reset the entire game? This CANNOT be undone!')) {
                return;
            }
            if (!confirm('Last chance! Reset game and lose all progress?')) {
                return;
            }

            try {
                const response = await fetch('/api/debug/reset', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessage('Game reset! Reloading...', 'success');
                    setTimeout(() => window.location.href = '/', 2000);
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Failed to reset game', 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        async function updateDebugInfo() {
            try {
                const responses = await Promise.all([
                    fetch('/api/time'),
                    fetch('/api/account')
                ]);

                const [timeData, accountData] = await Promise.all(responses.map(r => r.json()));

                const debugData = {
                    time: {
                        current: timeData.currentTime,
                        isPaused: timeData.isPaused,
                        multiplier: timeData.timeMultiplier,
                        isMarketOpen: timeData.isMarketOpen
                    },
                    account: {
                        cash: accountData.cash,
                        creditScore: accountData.creditScore,
                        portfolioSize: Object.keys(accountData.portfolio || {}).length,
                        loansCount: (accountData.loans || []).length,
                        transactionsCount: (accountData.transactions || []).length
                    }
                };

                document.getElementById('debugData').textContent = JSON.stringify(debugData, null, 2);
            } catch (error) {
                document.getElementById('debugData').textContent = 'Error loading debug info: ' + error.message;
            }
        }

        function refreshAll() {
            updateTimeDisplay();
            updateAccountDisplay();
            updateDebugInfo();
            showMessage('Data refreshed');
        }
        
        function forceEraTheme() {
            const selectedEra = document.getElementById('forceEraSelect').value;
            const body = document.body;
            
            // Remove all era classes
            body.className = body.className.replace(/era-\w+/g, '').trim();
            
            if (selectedEra) {
                // Apply forced era
                body.classList.add(\`era-\${selectedEra}\`);
                localStorage.setItem('forcedEra', selectedEra);
                showMessage(\`Theme forced to \${selectedEra}\`);
            } else {
                // Remove forced era, return to auto
                localStorage.removeItem('forcedEra');
                showMessage('Theme reset to auto mode');
                // Re-apply based on game year
                updateEraTheme();
            }
        }

        // Initialize
        updateTimeDisplay();
        updateAccountDisplay();
        updateDebugInfo();
        
        // Check if there's a forced era theme
        const forcedEra = localStorage.getItem('forcedEra');
        if (forcedEra) {
            document.getElementById('forceEraSelect').value = forcedEra;
            document.body.classList.add(\`era-\${forcedEra}\`);
        }
        
        setInterval(updateTimeDisplay, 2000);
        setInterval(updateAccountDisplay, 5000);
    </script>
    <script>
async function updateEraTheme() {
            const response = await fetch('/api/time');
            const data = await response.json();
            const gameDate = new Date(data.currentTime);
            const year = gameDate.getFullYear();
            applyEraTheme(year);
        }
        
        updateEraTheme();
        setInterval(updateEraTheme, 10000);
    </script>
    `
}) %>
