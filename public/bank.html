<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockFake - Bank Account</title>
    <link rel="stylesheet" href="era-themes.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
        }
        .nav {
            text-align: center;
            margin-bottom: 20px;
        }
        .nav a {
            color: #00ff00;
            margin: 0 10px;
            text-decoration: none;
        }
        .nav a:hover {
            text-decoration: underline;
        }
        .account-summary {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
        }
        .balance {
            font-size: 2em;
            text-align: center;
            margin: 20px 0;
            color: #00ff00;
        }
        .portfolio {
            background-color: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #003300;
        }
        th {
            background-color: #003300;
        }
        .total-value {
            font-size: 1.5em;
            text-align: right;
            margin-top: 20px;
            padding: 10px;
            border-top: 2px solid #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¶ BANK ACCOUNT</h1>
        <div class="nav">
            <a href="/">‚Üê Back to Portal</a> |
            <a href="/trading">Trading</a> |
            <a href="/loans">Loans</a> |
            <a href="/taxes">Taxes</a> |
            <a href="/news">News</a> |
            <a href="/email">Email</a>
        </div>
        
        <div class="account-summary">
            <h2>Account Summary</h2>
            <div class="balance">
                Cash Balance: $<span id="cashBalance">0.00</span>
            </div>
            <div class="balance" style="font-size: 1em; margin: 10px 0;">
                Purchasing Power (1970 dollars): $<span id="realValue">0.00</span>
                <span style="cursor: help; color: #00aa00; margin-left: 8px;" title="This shows what your current cash would be worth in 1970 dollars, adjusted for inflation. Your starting $10,000 in 1970 would be worth much more in today's dollars!">‚ÑπÔ∏è</span>
            </div>
            <div style="text-align: center; color: #00aa00; margin: 10px 0;">
                Inflation Rate: <span id="inflationRate">0</span>% | Cumulative: <span id="cumulativeInflation">1.0</span>x
            </div>
            <div style="text-align: center; color: #00ff00; margin: 10px 0; font-size: 1.2em;">
                Credit Score: <span id="creditScore">---</span>
            </div>
        </div>
        
        <div class="account-summary" id="marginSection" style="display: none;">
            <h2>üí∞ Margin Account</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                <div>
                    <div style="font-size: 0.9em; color: #00aa00;">Margin Balance (Borrowed):</div>
                    <div style="font-size: 1.5em; color: #ff8800; margin: 5px 0;">$<span id="marginBalance">0.00</span></div>
                </div>
                <div>
                    <div style="font-size: 0.9em; color: #00aa00;">Buying Power:</div>
                    <div style="font-size: 1.5em; color: #00ff00; margin: 5px 0;">$<span id="buyingPower">0.00</span></div>
                </div>
                <div>
                    <div style="font-size: 0.9em; color: #00aa00;">Current Leverage:</div>
                    <div style="font-size: 1.5em; margin: 5px 0;"><span id="currentLeverage">1.0</span>:1</div>
                </div>
                <div>
                    <div style="font-size: 0.9em; color: #00aa00;">Margin Ratio:</div>
                    <div style="font-size: 1.5em; margin: 5px 0;"><span id="marginRatio">100</span>%</div>
                </div>
            </div>
            <div id="marginCallWarning" style="display: none; background-color: #440000; border: 2px solid #ff0000; padding: 10px; margin-top: 15px; text-align: center; color: #ff0000; font-weight: bold;">
                ‚ö†Ô∏è MARGIN CALL: Deposit $<span id="marginCallAmount">0</span> or reduce positions
            </div>
        </div>
        
        <div class="portfolio">
            <h2>üìà Combined Portfolio (Stocks & Index Funds)</h2>
            <table id="combinedPortfolioTable">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>Shares</th>
                        <th>Avg Cost</th>
                        <th>Current Price</th>
                        <th>Total Value</th>
                        <th>Total Cost</th>
                        <th>Gain/Loss</th>
                        <th>Return %</th>
                    </tr>
                </thead>
                <tbody id="combinedPortfolioList">
                    <tr><td colspan="9">Loading...</td></tr>
                </tbody>
            </table>
            <div class="total-value">
                Total Invested: $<span id="totalCost">0.00</span>
            </div>
            <div class="total-value">
                Total Portfolio Value: $<span id="portfolioValue">0.00</span>
            </div>
            <div class="total-value" style="font-size: 1.5em;">
                Total Gain/Loss: <span id="totalGainLoss" class="positive">$0.00</span>
                (<span id="totalReturnPercent">0.00</span>%)
            </div>
            <div class="total-value">
                Total Account Value: $<span id="totalValue">0.00</span>
            </div>
        </div>
        
        <div class="portfolio" id="indexFundsSection" style="display: none;">
            <h2>üìä Index Fund Holdings</h2>
            <table>
                <thead>
                    <tr>
                        <th>Fund</th>
                        <th>Shares</th>
                        <th>Current Price</th>
                        <th>Total Value</th>
                        <th>Category</th>
                    </tr>
                </thead>
                <tbody id="indexFundsList">
                    <tr><td colspan="5">No index funds</td></tr>
                </tbody>
            </table>
            <div class="total-value">
                Total Index Funds Value: $<span id="indexFundsValue">0.00</span>
            </div>
        </div>
        
        <div class="portfolio" id="shortPositionsSection" style="display: none;">
            <h2>Short Positions</h2>
            <table>
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Shares</th>
                        <th>Borrow Price</th>
                        <th>Current Price</th>
                        <th>P&L</th>
                    </tr>
                </thead>
                <tbody id="shortPositionsList">
                    <tr><td colspan="5">No short positions</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="portfolio">
            <h2>Recent Transactions</h2>
            <table id="transactionsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Symbol</th>
                        <th>Shares</th>
                        <th>Price</th>
                        <th>Fee</th>
                        <th>Tax</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="transactionsList">
                    <tr><td colspan="8">No transactions</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="portfolio">
            <h2>Dividend History</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Quarter</th>
                        <th>Gross</th>
                        <th>Tax</th>
                        <th>Net</th>
                    </tr>
                </thead>
                <tbody id="dividendsList">
                    <tr><td colspan="5">No dividends yet</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="portfolio">
            <h2>Fees & Costs</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="feesList">
                    <tr><td colspan="4">No fees charged</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script src="table-sorter.js"></script>
    <script>
        let portfolioSorter, transactionsSorter;
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function updateAccount() {
            const [accountRes, stocksRes] = await Promise.all([
                fetch('/api/account'),
                fetch('/api/stocks')
            ]);
            
            const account = await accountRes.json();
            const stocks = await stocksRes.json();
            
            document.getElementById('cashBalance').textContent = account.cash.toFixed(2);
            
            // Update credit score
            if (account.creditScore) {
                document.getElementById('creditScore').textContent = account.creditScore;
            }
            
            // Update inflation data
            if (account.inflationData) {
                document.getElementById('realValue').textContent = account.inflationData.realValue.toFixed(2);
                document.getElementById('inflationRate').textContent = account.inflationData.currentRate.toFixed(1);
                document.getElementById('cumulativeInflation').textContent = account.inflationData.cumulativeInflation.toFixed(2);
            }
            
            // Build combined portfolio with extended information
            await updateCombinedPortfolio(account, stocks);
            
            // Display margin account information
            if (account.marginAccount && account.marginAccount.hasMarginEnabled) {
                const marginSection = document.getElementById('marginSection');
                marginSection.style.display = 'block';
                
                document.getElementById('marginBalance').textContent = account.marginAccount.marginBalance.toFixed(2);
                document.getElementById('buyingPower').textContent = account.marginAccount.buyingPower.toFixed(2);
                document.getElementById('currentLeverage').textContent = account.marginAccount.currentLeverage.toFixed(2);
                
                if (account.portfolioMetrics) {
                    document.getElementById('marginRatio').textContent = (account.portfolioMetrics.marginRatio * 100).toFixed(1);
                    
                    // Show margin call warning if applicable
                    if (account.portfolioMetrics.marginCallStatus && account.portfolioMetrics.marginCallStatus.isMarginCall) {
                        const marginCallWarning = document.getElementById('marginCallWarning');
                        marginCallWarning.style.display = 'block';
                        document.getElementById('marginCallAmount').textContent = account.portfolioMetrics.marginCallStatus.amountNeeded.toFixed(2);
                    } else {
                        document.getElementById('marginCallWarning').style.display = 'none';
                    }
                }
            }
            
            // Display index fund holdings
            let indexFundsValue = 0;
            const indexFundsSection = document.getElementById('indexFundsSection');
            const indexFundsList = document.getElementById('indexFundsList');
            
            if (account.indexFundHoldings && Object.keys(account.indexFundHoldings).length > 0) {
                indexFundsSection.style.display = 'block';
                
                // Fetch index fund prices
                const indexFundsRes = await fetch('/api/indexfunds');
                const indexFunds = await indexFundsRes.json();
                
                indexFundsList.innerHTML = Object.entries(account.indexFundHoldings)
                    .filter(([_, holding]) => holding.shares > 0)
                    .map(([symbol, holding]) => {
                        const fund = indexFunds.find(f => f.symbol === symbol);
                        const currentPrice = fund ? fund.price : 0;
                        const value = holding.shares * currentPrice;
                        indexFundsValue += value;
                        
                        return `
                            <tr>
                                <td>${symbol}</td>
                                <td>${holding.shares.toFixed(2)}</td>
                                <td>$${currentPrice.toFixed(2)}</td>
                                <td>$${value.toFixed(2)}</td>
                                <td>${fund ? fund.category : 'N/A'}</td>
                            </tr>
                        `;
                    }).join('');
                    
                document.getElementById('indexFundsValue').textContent = indexFundsValue.toFixed(2);
            } else {
                indexFundsSection.style.display = 'none';
            }
            
            // Update total value to include index funds
            document.getElementById('totalValue').textContent = (account.cash + portfolioValue + indexFundsValue).toFixed(2);
            
            // Update short positions
            const shortPositionsSection = document.getElementById('shortPositionsSection');
            const shortPositionsList = document.getElementById('shortPositionsList');
            if (account.shortPositions && Object.keys(account.shortPositions).length > 0) {
                shortPositionsSection.style.display = 'block';
                shortPositionsList.innerHTML = Object.entries(account.shortPositions)
                    .filter(([_, position]) => position.shares > 0)
                    .map(([symbol, position]) => {
                        const stock = stocks.find(s => s.symbol === symbol);
                        const currentPrice = stock ? stock.price : 0;
                        const pnl = (position.borrowPrice - currentPrice) * position.shares;
                        const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                        
                        return `
                            <tr>
                                <td>${symbol}</td>
                                <td>${position.shares}</td>
                                <td>$${position.borrowPrice.toFixed(2)}</td>
                                <td>$${currentPrice.toFixed(2)}</td>
                                <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('');
            } else {
                shortPositionsSection.style.display = 'none';
            }
            
            // Update transactions list
            const transactionsList = document.getElementById('transactionsList');
            if (!account.transactions || account.transactions.length === 0) {
                transactionsList.innerHTML = '<tr><td colspan="8">No transactions</td></tr>';
            } else {
                transactionsList.innerHTML = account.transactions.slice().reverse().map(tx => `
                    <tr>
                        <td>${new Date(tx.date).toLocaleDateString()}</td>
                        <td>${escapeHtml(tx.type.toUpperCase())}</td>
                        <td>${escapeHtml(tx.symbol)}</td>
                        <td>${tx.shares}</td>
                        <td>$${tx.pricePerShare.toFixed(2)}</td>
                        <td>${tx.tradingFee ? '$' + tx.tradingFee.toFixed(2) : '-'}</td>
                        <td>${tx.tax ? '$' + tx.tax.toFixed(2) : '-'}</td>
                        <td>$${(tx.netProceeds || tx.total).toFixed(2)}</td>
                    </tr>
                `).join('');
                
                // Initialize or refresh sorter for transactions
                if (!transactionsSorter) {
                    transactionsSorter = makeSortable('transactionsTable');
                } else {
                    transactionsSorter.refresh();
                }
            }
            
            // Update dividends list
            const dividendsList = document.getElementById('dividendsList');
            if (!account.dividends || account.dividends.length === 0) {
                dividendsList.innerHTML = '<tr><td colspan="5">No dividends yet</td></tr>';
            } else {
                dividendsList.innerHTML = account.dividends.slice().reverse().map(div => `
                    <tr>
                        <td>${new Date(div.date).toLocaleDateString()}</td>
                        <td>${escapeHtml(div.quarter)}</td>
                        <td>$${div.grossAmount.toFixed(2)}</td>
                        <td>$${div.tax.toFixed(2)}</td>
                        <td>$${div.netAmount.toFixed(2)}</td>
                    </tr>
                `).join('');
            }
            
            // Update fees list
            const feesList = document.getElementById('feesList');
            if (!account.fees || account.fees.length === 0) {
                feesList.innerHTML = '<tr><td colspan="4">No fees charged</td></tr>';
            } else {
                feesList.innerHTML = account.fees.slice().reverse().map(fee => `
                    <tr>
                        <td>${new Date(fee.date).toLocaleDateString()}</td>
                        <td>${escapeHtml(fee.type)}</td>
                        <td>$${fee.amount.toFixed(2)}</td>
                        <td>${escapeHtml(fee.description)}</td>
                    </tr>
                `).join('');
            }
        }
        
        // Update combined portfolio with extended information
        async function updateCombinedPortfolio(account, stocks) {
            const combinedList = document.getElementById('combinedPortfolioList');
            let totalPortfolioValue = 0;
            let totalCost = 0;
            const positions = [];
            
            // Fetch index funds data
            const indexFundsRes = await fetch('/api/indexfunds');
            const indexFunds = await indexFundsRes.json();
            
            // Process stock positions
            for (const [symbol, shares] of Object.entries(account.portfolio)) {
                if (shares <= 0) continue;
                
                const stock = stocks.find(s => s.symbol === symbol);
                const currentPrice = stock ? stock.price : 0;
                const totalValue = shares * currentPrice;
                
                // Calculate average cost from purchase history
                let avgCost = 0;
                let positionCost = 0;
                if (account.purchaseHistory && account.purchaseHistory[symbol]) {
                    let totalShares = 0;
                    let totalPaid = 0;
                    account.purchaseHistory[symbol].forEach(purchase => {
                        totalShares += purchase.shares;
                        totalPaid += purchase.shares * purchase.pricePerShare;
                    });
                    if (totalShares > 0) {
                        avgCost = totalPaid / totalShares;
                        positionCost = shares * avgCost;
                    }
                }
                
                const gainLoss = totalValue - positionCost;
                const returnPercent = positionCost > 0 ? (gainLoss / positionCost) * 100 : 0;
                
                positions.push({
                    symbol,
                    type: 'üìà Stock',
                    shares,
                    avgCost,
                    currentPrice,
                    totalValue,
                    totalCost: positionCost,
                    gainLoss,
                    returnPercent
                });
                
                totalPortfolioValue += totalValue;
                totalCost += positionCost;
            }
            
            // Process index fund positions
            if (account.indexFundHoldings) {
                for (const [symbol, holding] of Object.entries(account.indexFundHoldings)) {
                    if (holding.shares <= 0) continue;
                    
                    const fund = indexFunds.find(f => f.symbol === symbol);
                    const currentPrice = fund ? fund.price : 0;
                    const totalValue = holding.shares * currentPrice;
                    
                    // Calculate average cost
                    let avgCost = 0;
                    let positionCost = 0;
                    if (holding.purchaseHistory && holding.purchaseHistory.length > 0) {
                        let totalShares = 0;
                        let totalPaid = 0;
                        holding.purchaseHistory.forEach(purchase => {
                            totalShares += purchase.shares;
                            totalPaid += purchase.shares * purchase.pricePerShare;
                        });
                        if (totalShares > 0) {
                            avgCost = totalPaid / totalShares;
                            positionCost = holding.shares * avgCost;
                        }
                    }
                    
                    const gainLoss = totalValue - positionCost;
                    const returnPercent = positionCost > 0 ? (gainLoss / positionCost) * 100 : 0;
                    
                    positions.push({
                        symbol,
                        type: 'üìä Index Fund',
                        shares: holding.shares,
                        avgCost,
                        currentPrice,
                        totalValue,
                        totalCost: positionCost,
                        gainLoss,
                        returnPercent
                    });
                    
                    totalPortfolioValue += totalValue;
                    totalCost += positionCost;
                }
            }
            
            // Render combined portfolio
            if (positions.length === 0) {
                combinedList.innerHTML = '<tr><td colspan="9">No positions</td></tr>';
            } else {
                combinedList.innerHTML = positions.map(pos => {
                    const gainLossClass = pos.gainLoss >= 0 ? 'positive' : 'negative';
                    const returnClass = pos.returnPercent >= 0 ? 'positive' : 'negative';
                    
                    return `
                        <tr>
                            <td><strong>${pos.symbol}</strong></td>
                            <td>${pos.type}</td>
                            <td>${pos.shares.toFixed(2)}</td>
                            <td>$${pos.avgCost.toFixed(2)}</td>
                            <td>$${pos.currentPrice.toFixed(2)}</td>
                            <td>$${pos.totalValue.toFixed(2)}</td>
                            <td>$${pos.totalCost.toFixed(2)}</td>
                            <td class="${gainLossClass}">$${pos.gainLoss.toFixed(2)}</td>
                            <td class="${returnClass}">${pos.returnPercent.toFixed(2)}%</td>
                        </tr>
                    `;
                }).join('');
                
                // Initialize or refresh sorter
                if (!portfolioSorter) {
                    portfolioSorter = makeSortable('combinedPortfolioTable', {
                        defaultSort: { column: 5, direction: 'desc' } // Sort by Total Value descending
                    });
                } else {
                    portfolioSorter.refresh();
                }
            }
            
            // Update totals
            document.getElementById('totalCost').textContent = totalCost.toFixed(2);
            document.getElementById('portfolioValue').textContent = totalPortfolioValue.toFixed(2);
            
            const totalGainLoss = totalPortfolioValue - totalCost;
            const totalReturn = totalCost > 0 ? (totalGainLoss / totalCost) * 100 : 0;
            
            const gainLossEl = document.getElementById('totalGainLoss');
            gainLossEl.textContent = '$' + totalGainLoss.toFixed(2);
            gainLossEl.className = totalGainLoss >= 0 ? 'positive' : 'negative';
            
            document.getElementById('totalReturnPercent').textContent = totalReturn.toFixed(2);
            document.getElementById('totalValue').textContent = (account.cash + totalPortfolioValue).toFixed(2);
        }
        
        updateAccount();
        setInterval(updateAccount, 2000);
    </script>
    <script src="common.js"></script>
    <script>
        let transactionsPaginator, dividendsPaginator, feesPaginator;
        
        // Apply era theme based on game time
        async function updateEraTheme() {
            const response = await fetch('/api/time');
            const data = await response.json();
            const gameDate = new Date(data.currentTime);
            const year = gameDate.getFullYear();
            applyEraTheme(year);
        }
        
        updateEraTheme();
        setInterval(updateEraTheme, 10000);
    </script>
</body>
</html>
